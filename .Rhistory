# Show pathways with their mean abundance
related_data <- data.frame(
pathway = related,
mean_abundance = rowMeans(abundance[related, , drop = FALSE]),
total_abundance = rowSums(abundance[related, , drop = FALSE]),
detection_rate = rowSums(abundance[related, , drop = FALSE] > 0)
) %>%
arrange(desc(mean_abundance))
print(head(related_data, 20))
write.csv(related_data, "picrust2_output_final/related_pathways.csv", row.names = FALSE)
cat("\nSaved related pathways to: related_pathways.csv\n")
} else {
cat("  No related pathways found\n")
}
# Show sample of all available pathways
cat("\nFirst 10 pathways in dataset:\n")
print(head(rownames(abundance), 10))
cat("...\n")
cat("Total pathways in dataset:", nrow(abundance), "\n")
}
# ============= Analysis 2: EC Number Search =============
cat("\n=== EC Number Search ===\n")
# Define the path to the EC_metagenome_out table
ec_table_path <- "picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv"
# Define the EC numbers to search for
target_ecs <- c("1.14.18.3", "2.1.1.21")
# Read the EC_metagenome_out table, ensuring the first column is named explicitly
ec_table <- read_tsv(ec_table_path, col_types = cols(), col_names = TRUE) %>%
rename(EC = 1)  # Rename the first column to 'EC'
# Filter the table for the target EC numbers
filtered_ecs <- ec_table %>%
filter(EC %in% target_ecs)
# Summarize the abundance of the target EC numbers
summary_ecs <- filtered_ecs %>%
pivot_longer(cols = -EC, names_to = "Sample", values_to = "Abundance") %>%
group_by(EC) %>%
summarise(Total_Abundance = sum(Abundance, na.rm = TRUE))
# Save the filtered and summarized results
write_tsv(filtered_ecs, "picrust2_output_final/EC_metagenome_out/filtered_ecs.tsv")
# ============= Analysis 4: Methanogenesis and Methanotroph Pathways =============
cat("\n=== Methanogenesis and Methanotroph Analysis ===\n")
# ---------------------------------------------------------
# 1. Define Target Features
# ---------------------------------------------------------
methane_pathways <- list(
methanogenesis = c("METHANOGENESIS-PWY", "PWY-7084", "PWY-5173", "PWY-7255", "METHGLYUT-PWY"),
methanotroph = c("METHANE-OXIDATION-PWY", "PWY-7357", "FORMALDEHYDE-OXIDATION-PWY", "PWY-7013")
)
methane_enzymes <- list(
methanogenesis = list(
EC = c("2.8.4.1", "1.12.98.1", "2.1.1.86", "1.2.7.4", "2.3.1.101"),
KO = c("K00399", "K00401", "K00402", "K00577", "K00578", "K00579", "K00580", "K00581", "K00582", "K00583", "K00584", "K00200", "K00201", "K00202", "K00672", "K01499")
),
methanotroph = list(
EC = c("1.14.13.25", "1.14.18.3", "1.1.1.1", "1.2.1.46", "1.1.2.7"),
KO = c("K10944", "K10945", "K10946", "K16157", "K16158", "K16159", "K14028", "K14029", "K00121", "K00122", "K08691")
)
)
# ---------------------------------------------------------
# 2. Load Annotation Databases
# ---------------------------------------------------------
cat("\n--- Loading Annotation Databases ---\n")
ensure_file <- function(url, file_path) {
if (!file.exists(file_path)) {
cat("Downloading:", file_path, "...\n")
tryCatch(download.file(url, file_path, method = "auto"), error = function(e) cat("Download failed:", url, "\n"))
}
}
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ko_info.tsv.gz", "picrust2_output_final/ko_info.tsv.gz")
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ec_level4_info.tsv.gz", "picrust2_output_final/ec_level4_info.tsv.gz")
load_desc <- function(path) if(file.exists(path)) read_tsv(path, col_names = c("ID", "Description"), col_types = "cc") else data.frame(ID=character(), Description=character())
enzyme_descriptions <- bind_rows(load_desc("picrust2_output_final/ko_info.tsv.gz"), load_desc("picrust2_output_final/ec_level4_info.tsv.gz"))
# ---------------------------------------------------------
# 3. Helper Functions
# ---------------------------------------------------------
analyze_features <- function(data, features, type_name, id_col = "ID") {
found <- data %>% filter(!!sym(id_col) %in% features)
if (nrow(found) > 0) {
cat("Found", nrow(found), type_name, "features:\n")
summary <- found %>%
mutate(mean_abundance = rowMeans(select(., -all_of(id_col)), na.rm = TRUE),
total_abundance = rowSums(select(., -all_of(id_col)), na.rm = TRUE),
detection_samples = rowSums(select(., -all_of(id_col)) > 0)) %>%
select(all_of(id_col), mean_abundance, total_abundance, detection_samples) %>%
left_join(enzyme_descriptions, by = setNames("ID", id_col)) %>%
select(all_of(id_col), Description, everything()) %>%
arrange(desc(mean_abundance))
print(summary)
return(list(summary = summary, raw = found))
} else {
cat("No", type_name, "features found.\n")
return(NULL)
}
}
process_enzyme_file <- function(file_path, id_col, target_list, prefix) {
if (file.exists(file_path)) {
data <- read_delim(file_path, delim = "\t", trim_ws = TRUE) %>% rename(!!id_col := 1)
if (id_col == "KO") data$KO <- gsub("ko:", "", data$KO)
for (group in names(target_list)) {
cat("\n---", group, id_col, "---\n")
res <- analyze_features(data, target_list[[group]][[id_col]], paste(group, id_col), id_col)
if (!is.null(res)) {
write.csv(res$summary, paste0("picrust2_output_final/", group, "_", id_col, "_summary.csv"), row.names = FALSE)
write.csv(res$raw, paste0("picrust2_output_final/", group, "_", id_col, "_abundance.csv"), row.names = FALSE)
}
}
} else {
cat("File not found:", file_path, "\n")
}
}
# Pathways
cat("\n--- Pathway Analysis ---\n")
for (group in names(methane_pathways)) {
cat("\nChecking", group, "pathways:\n")
found <- intersect(rownames(abundance), methane_pathways[[group]])
if (length(found) > 0) {
for (pw in found) cat("  -", pw, "(mean:", round(mean(as.numeric(abundance[pw, ]), na.rm=TRUE), 2), ")\n")
} else cat("  None found.\n")
}
# Broad Search
cat("\n--- Broad Keyword Search ---\n")
keywords <- c("methane", "methan", "methyl", "formaldehyde", "formate", "C1")
matches <- unique(grep(paste(keywords, collapse="|"), rownames(abundance), ignore.case=TRUE, value=TRUE))
if (length(matches) > 0) {
cat("Found", length(matches), "related pathways.\n")
res <- data.frame(pathway = matches, mean = rowMeans(abundance[matches,,drop=FALSE], na.rm=TRUE)) %>% arrange(desc(mean))
write.csv(res, "picrust2_output_final/methane_related_pathways.csv", row.names=FALSE)
}
# Enzymes (KO & EC)
process_enzyme_file("picrust2_output_final/KO_metagenome_out/pred_metagenome_unstrat.tsv", "KO", methane_enzymes, "KO")
process_enzyme_file("picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv", "EC", methane_enzymes, "EC")
# Enzymes (KO & EC)
process_enzyme_file("picrust2_output_final/KO_metagenome_out/pred_metagenome_unstrat.tsv", "KO", methane_enzymes, "KO")
process_enzyme_file("picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv", "EC", methane_enzymes, "EC")
# PICRUSt2 Pathway Differential Abundance Analysis
library(readr)
library(ggpicrust2)
library(tidyverse)
library(ggplot2)
library(dplyr)
# Load data
abundance_file <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/picrust2_output_final/pathways_out/path_abun_unstrat.tsv"
metadata <- read_delim("/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/Data/metadata/metadata.tsv",
delim = "\t", trim_ws = TRUE)
abundance <- read_delim(abundance_file, delim = "\t", trim_ws = TRUE) %>%
column_to_rownames(var = colnames(.)[1])
# Filter and match samples
clean_metadata <- metadata %>% filter(control_status == "sample")
common_samples <- intersect(colnames(abundance), clean_metadata$`sample-id`)
abundance <- abundance %>% select(all_of(common_samples))
clean_metadata <- clean_metadata %>%
filter(`sample-id` %in% common_samples) %>%
arrange(match(`sample-id`, common_samples))
cat("Analyzing", ncol(abundance), "samples and", nrow(abundance), "pathways\n")
# ============= Analysis 1: Species comparison =============
cat("\n=== Species comparison ===\n")
daa_species <- pathway_daa(abundance = abundance, metadata = clean_metadata,
group = "species", daa_method = "LinDA") %>%
pathway_annotation(pathway = "MetaCyc", daa_results_df = ., ko_to_kegg = FALSE)
cat("  Significant pathways (p < 0.05):", sum(daa_species$p_adjust < 0.05, na.rm = TRUE), "\n")
# Plot
p1 <- daa_species %>% arrange(p_adjust) %>% head(30) %>%
ggplot(aes(x = reorder(description, -log10(p_adjust)), y = -log10(p_adjust))) +
geom_bar(stat = "identity", aes(fill = p_adjust < 0.05)) +
scale_fill_manual(values = c("steelblue", "gray70")) +
coord_flip() + theme_bw() +
labs(title = "Top 30 Pathways (Species)", x = "Pathway", y = "-log10(p_adjust)")
p1
# ============= Analysis 2: Sample type comparison =============
cat("\n=== Sample type comparison ===\n")
daa_type <- pathway_daa(abundance = abundance, metadata = clean_metadata,
group = "sample_type", daa_method = "LinDA") %>%
pathway_annotation(pathway = "MetaCyc", daa_results_df = ., ko_to_kegg = FALSE)
cat("  Significant pathways (p < 0.05):", sum(daa_type$p_adjust < 0.05, na.rm = TRUE), "\n")
# Plot
p2 <- daa_type %>% arrange(p_adjust) %>% head(30) %>%
ggplot(aes(x = reorder(description, -log10(p_adjust)), y = -log10(p_adjust))) +
geom_bar(stat = "identity", aes(fill = p_adjust < 0.05)) +
scale_fill_manual(values = c("steelblue", "gray70")) +
coord_flip() + theme_bw() +
labs(title = "Top 30 Pathways (Sample Type)", x = "Pathway", y = "-log10(p_adjust)")
p2
# ============= Analysis 3: Methane oxidation pathway =============
cat("\n=== Methane oxidation pathway ===\n")
methane_id <- "METHANE-OXIDATION-PWY"
if (methane_id %in% rownames(abundance)) {
# Extract and prepare data
methane_data <- data.frame(
sample_id = colnames(abundance),
abundance = as.numeric(abundance[methane_id, ])
) %>%
left_join(clean_metadata, by = c("sample_id" = "sample-id"))
# Statistics
cat("  Detection rate:", sum(methane_data$abundance > 0), "/", nrow(methane_data), "\n")
cat("  Mean abundance:", round(mean(methane_data$abundance), 2), "\n")
# Group summaries
cat("\nBy species:\n")
print(methane_data %>% group_by(species) %>%
summarise(mean = mean(abundance), n_detected = sum(abundance > 0)))
cat("\nBy sample type:\n")
print(methane_data %>% group_by(sample_type) %>%
summarise(mean = mean(abundance), n_detected = sum(abundance > 0)))
# Visualizations
p3 <- ggplot(methane_data, aes(x = species, y = abundance, fill = sample_type)) +
geom_boxplot(alpha = 0.7) +
geom_point(position = position_jitterdodge(0.2), size = 2, alpha = 0.6) +
theme_bw() + labs(title = "METHANE-OXIDATION-PWY Abundance")
ggsave("picrust2_output_final/methane_boxplot.pdf", p3, width = 10, height = 6)
p4 <- ggplot(methane_data, aes(x = sample_id, y = methane_id, fill = abundance)) +
geom_tile() + scale_fill_gradient(low = "white", high = "darkred") +
facet_grid(~ species + sample_type, scales = "free_x", space = "free_x") +
theme_bw() + labs(title = "METHANE-OXIDATION-PWY Heatmap") +
theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
ggsave("picrust2_output_final/methane_heatmap.pdf", p4, width = 12, height = 4)
write.csv(methane_data, "picrust2_output_final/methane_abundance.csv", row.names = FALSE)
cat("\nSaved: methane_abundance.csv, methane_boxplot.pdf, methane_heatmap.pdf\n")
} else {
cat("  Pathway", methane_id, "not found in dataset\n")
# Search for related pathways
cat("\nSearching for methane/oxidation-related pathways...\n")
related <- grep("methane|oxidation|METHYL|methan", rownames(abundance),
ignore.case = TRUE, value = TRUE)
if (length(related) > 0) {
cat("  Found", length(related), "related pathway(s):\n")
# Show pathways with their mean abundance
related_data <- data.frame(
pathway = related,
mean_abundance = rowMeans(abundance[related, , drop = FALSE]),
total_abundance = rowSums(abundance[related, , drop = FALSE]),
detection_rate = rowSums(abundance[related, , drop = FALSE] > 0)
) %>%
arrange(desc(mean_abundance))
print(head(related_data, 20))
write.csv(related_data, "picrust2_output_final/related_pathways.csv", row.names = FALSE)
cat("\nSaved related pathways to: related_pathways.csv\n")
} else {
cat("  No related pathways found\n")
}
# Show sample of all available pathways
cat("\nFirst 10 pathways in dataset:\n")
print(head(rownames(abundance), 10))
cat("...\n")
cat("Total pathways in dataset:", nrow(abundance), "\n")
}
# ---------------------------------------------------------
# Load Annotation Databases (Global)
# ---------------------------------------------------------
cat("\n--- Loading Annotation Databases ---\n")
ensure_file <- function(url, file_path) {
if (!file.exists(file_path)) {
cat("Downloading:", file_path, "...\n")
tryCatch(download.file(url, file_path, method = "auto"), error = function(e) cat("Download failed:", url, "\n"))
}
}
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ko_info.tsv.gz", "picrust2_output_final/ko_info.tsv.gz")
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ec_level4_info.tsv.gz", "picrust2_output_final/ec_level4_info.tsv.gz")
load_desc <- function(path) if(file.exists(path)) read_tsv(path, col_names = c("ID", "Description"), col_types = "cc") else data.frame(ID=character(), Description=character())
enzyme_descriptions <- bind_rows(load_desc("picrust2_output_final/ko_info.tsv.gz"), load_desc("picrust2_output_final/ec_level4_info.tsv.gz")) %>%
mutate(ID = gsub("^EC:", "", ID), ID = gsub("^ko:", "", ID))
# ============= Analysis 2: EC Number Search =============
cat("\n=== EC Number Search ===\n")
# Define the path to the EC_metagenome_out table
ec_table_path <- "picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv"
# Define the EC numbers to search for
target_ecs <- c("1.14.18.3", "2.1.1.21")
# Read the EC_metagenome_out table, ensuring the first column is named explicitly
ec_table <- read_tsv(ec_table_path, col_types = cols(), col_names = TRUE) %>%
rename(EC = 1)  # Rename the first column to 'EC'
# Filter the table for the target EC numbers
filtered_ecs <- ec_table %>%
filter(EC %in% target_ecs) %>%
left_join(enzyme_descriptions, by = c("EC" = "ID")) %>%
select(EC, Description, everything())
# Summarize the abundance of the target EC numbers
summary_ecs <- filtered_ecs %>%
pivot_longer(cols = -c(EC, Description), names_to = "Sample", values_to = "Abundance") %>%
group_by(EC, Description) %>%
summarise(Total_Abundance = sum(Abundance, na.rm = TRUE))
# Print a message to indicate completion
cat("Filtered and summarized EC data saved to 'filtered_ecs.tsv' and 'summary_ecs.tsv'\n")
print(filtered_ecs)
View(filtered_ecs)
# PICRUSt2 Pathway Differential Abundance Analysis
library(readr)
library(ggpicrust2)
library(tidyverse)
library(ggplot2)
library(dplyr)
# Load data
abundance_file <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/picrust2_output_final/pathways_out/path_abun_unstrat.tsv"
metadata <- read_delim("/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/Data/metadata/metadata.tsv",
delim = "\t", trim_ws = TRUE)
abundance <- read_delim(abundance_file, delim = "\t", trim_ws = TRUE) %>%
column_to_rownames(var = colnames(.)[1])
# Filter and match samples
clean_metadata <- metadata %>% filter(control_status == "sample")
common_samples <- intersect(colnames(abundance), clean_metadata$`sample-id`)
abundance <- abundance %>% select(all_of(common_samples))
clean_metadata <- clean_metadata %>%
filter(`sample-id` %in% common_samples) %>%
arrange(match(`sample-id`, common_samples))
cat("Analyzing", ncol(abundance), "samples and", nrow(abundance), "pathways\n")
# ============= Analysis 1: Species comparison =============
cat("\n=== Species comparison ===\n")
daa_species <- pathway_daa(abundance = abundance, metadata = clean_metadata,
group = "species", daa_method = "LinDA") %>%
pathway_annotation(pathway = "MetaCyc", daa_results_df = ., ko_to_kegg = FALSE)
cat("  Significant pathways (p < 0.05):", sum(daa_species$p_adjust < 0.05, na.rm = TRUE), "\n")
# Plot
p1 <- daa_species %>% arrange(p_adjust) %>% head(30) %>%
ggplot(aes(x = reorder(description, -log10(p_adjust)), y = -log10(p_adjust))) +
geom_bar(stat = "identity", aes(fill = p_adjust < 0.05)) +
scale_fill_manual(values = c("steelblue", "gray70")) +
coord_flip() + theme_bw() +
labs(title = "Top 30 Pathways (Species)", x = "Pathway", y = "-log10(p_adjust)")
# ============= Analysis 2: Sample type comparison =============
cat("\n=== Sample type comparison ===\n")
daa_type <- pathway_daa(abundance = abundance, metadata = clean_metadata,
group = "sample_type", daa_method = "LinDA") %>%
pathway_annotation(pathway = "MetaCyc", daa_results_df = ., ko_to_kegg = FALSE)
cat("  Significant pathways (p < 0.05):", sum(daa_type$p_adjust < 0.05, na.rm = TRUE), "\n")
# Plot
p2 <- daa_type %>% arrange(p_adjust) %>% head(30) %>%
ggplot(aes(x = reorder(description, -log10(p_adjust)), y = -log10(p_adjust))) +
geom_bar(stat = "identity", aes(fill = p_adjust < 0.05)) +
scale_fill_manual(values = c("steelblue", "gray70")) +
coord_flip() + theme_bw() +
labs(title = "Top 30 Pathways (Sample Type)", x = "Pathway", y = "-log10(p_adjust)")
# ============= Analysis 3: Methane oxidation pathway =============
cat("\n=== Methane oxidation pathway ===\n")
methane_id <- "METHANE-OXIDATION-PWY"
if (methane_id %in% rownames(abundance)) {
# Extract and prepare data
methane_data <- data.frame(
sample_id = colnames(abundance),
abundance = as.numeric(abundance[methane_id, ])
) %>%
left_join(clean_metadata, by = c("sample_id" = "sample-id"))
# Statistics
cat("  Detection rate:", sum(methane_data$abundance > 0), "/", nrow(methane_data), "\n")
cat("  Mean abundance:", round(mean(methane_data$abundance), 2), "\n")
# Group summaries
cat("\nBy species:\n")
print(methane_data %>% group_by(species) %>%
summarise(mean = mean(abundance), n_detected = sum(abundance > 0)))
cat("\nBy sample type:\n")
print(methane_data %>% group_by(sample_type) %>%
summarise(mean = mean(abundance), n_detected = sum(abundance > 0)))
# Visualizations
p3 <- ggplot(methane_data, aes(x = species, y = abundance, fill = sample_type)) +
geom_boxplot(alpha = 0.7) +
geom_point(position = position_jitterdodge(0.2), size = 2, alpha = 0.6) +
theme_bw() + labs(title = "METHANE-OXIDATION-PWY Abundance")
ggsave("picrust2_output_final/methane_boxplot.pdf", p3, width = 10, height = 6)
p4 <- ggplot(methane_data, aes(x = sample_id, y = methane_id, fill = abundance)) +
geom_tile() + scale_fill_gradient(low = "white", high = "darkred") +
facet_grid(~ species + sample_type, scales = "free_x", space = "free_x") +
theme_bw() + labs(title = "METHANE-OXIDATION-PWY Heatmap") +
theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
ggsave("picrust2_output_final/methane_heatmap.pdf", p4, width = 12, height = 4)
write.csv(methane_data, "picrust2_output_final/methane_abundance.csv", row.names = FALSE)
cat("\nSaved: methane_abundance.csv, methane_boxplot.pdf, methane_heatmap.pdf\n")
} else {
cat("  Pathway", methane_id, "not found in dataset\n")
# Search for related pathways
cat("\nSearching for methane/oxidation-related pathways...\n")
related <- grep("methane|oxidation|METHYL|methan", rownames(abundance),
ignore.case = TRUE, value = TRUE)
if (length(related) > 0) {
cat("  Found", length(related), "related pathway(s):\n")
# Show pathways with their mean abundance
related_data <- data.frame(
pathway = related,
mean_abundance = rowMeans(abundance[related, , drop = FALSE]),
total_abundance = rowSums(abundance[related, , drop = FALSE]),
detection_rate = rowSums(abundance[related, , drop = FALSE] > 0)
) %>%
arrange(desc(mean_abundance))
print(head(related_data, 20))
write.csv(related_data, "picrust2_output_final/related_pathways.csv", row.names = FALSE)
cat("\nSaved related pathways to: related_pathways.csv\n")
} else {
cat("  No related pathways found\n")
}
# Show sample of all available pathways
cat("\nFirst 10 pathways in dataset:\n")
print(head(rownames(abundance), 10))
cat("...\n")
cat("Total pathways in dataset:", nrow(abundance), "\n")
}
# ---------------------------------------------------------
# Load Annotation Databases (Global)
# ---------------------------------------------------------
cat("\n--- Loading Annotation Databases ---\n")
ensure_file <- function(url, file_path) {
if (!file.exists(file_path)) {
cat("Downloading:", file_path, "...\n")
tryCatch(download.file(url, file_path, method = "auto"), error = function(e) cat("Download failed:", url, "\n"))
}
}
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ko_info.tsv.gz", "picrust2_output_final/ko_info.tsv.gz")
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ec_level4_info.tsv.gz", "picrust2_output_final/ec_level4_info.tsv.gz")
load_desc <- function(path) if(file.exists(path)) read_tsv(path, col_names = c("ID", "Description"), col_types = "cc") else data.frame(ID=character(), Description=character())
enzyme_descriptions <- bind_rows(load_desc("picrust2_output_final/ko_info.tsv.gz"), load_desc("picrust2_output_final/ec_level4_info.tsv.gz")) %>%
mutate(ID = gsub("^EC:", "", ID), ID = gsub("^ko:", "", ID))
# Manual additions for missing enzymes (e.g. obsolete EC numbers found in data)
manual_desc <- data.frame(
ID = c("2.1.1.21"),
Description = c("N5-methyltetrahydromethanopterin:coenzyme M methyltransferase (transferred to 2.1.1.86)"),
stringsAsFactors = FALSE
)
enzyme_descriptions <- bind_rows(enzyme_descriptions, manual_desc)
# ============= Analysis 2: EC Number Search =============
cat("\n=== EC Number Search ===\n")
# Define the path to the EC_metagenome_out table
ec_table_path <- "picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv"
# Define the EC numbers to search for
target_ecs <- c("1.14.18.3", "2.1.1.21")
# Read the EC_metagenome_out table, ensuring the first column is named explicitly
ec_table <- read_tsv(ec_table_path, col_types = cols(), col_names = TRUE) %>%
rename(EC = 1)  # Rename the first column to 'EC'
# Filter the table for the target EC numbers
filtered_ecs <- ec_table %>%
filter(EC %in% target_ecs) %>%
left_join(enzyme_descriptions, by = c("EC" = "ID")) %>%
select(EC, Description, everything())
# Summarize the abundance of the target EC numbers
summary_ecs <- filtered_ecs %>%
pivot_longer(cols = -c(EC, Description), names_to = "Sample", values_to = "Abundance") %>%
group_by(EC, Description) %>%
summarise(Total_Abundance = sum(Abundance, na.rm = TRUE))
# Print a message to indicate completion
cat("Filtered and summarized EC data saved to 'filtered_ecs.tsv' and 'summary_ecs.tsv'\n")
print(filtered_ecs)
# ============= Analysis 4: Methanogenesis and Methanotroph Pathways =============
cat("\n=== Methanogenesis and Methanotroph Analysis ===\n")
# ---------------------------------------------------------
# 1. Define Target Features
# ---------------------------------------------------------
methane_pathways <- list(
methanogenesis = c("METHANOGENESIS-PWY", "PWY-7084", "PWY-5173", "PWY-7255", "METHGLYUT-PWY"),
methanotroph = c("METHANE-OXIDATION-PWY", "PWY-7357", "FORMALDEHYDE-OXIDATION-PWY", "PWY-7013")
)
methane_enzymes <- list(
methanogenesis = list(
EC = c("2.8.4.1", "1.12.98.1", "2.1.1.86", "1.2.7.4", "2.3.1.101"),
KO = c("K00399", "K00401", "K00402", "K00577", "K00578", "K00579", "K00580", "K00581", "K00582", "K00583", "K00584", "K00200", "K00201", "K00202", "K00672", "K01499")
),
methanotroph = list(
EC = c("1.14.13.25", "1.14.18.3", "1.1.1.1", "1.2.1.46", "1.1.2.7"),
KO = c("K10944", "K10945", "K10946", "K16157", "K16158", "K16159", "K14028", "K14029", "K00121", "K00122", "K08691")
)
)
# ---------------------------------------------------------
# 3. Helper Functions
# ---------------------------------------------------------
analyze_features <- function(data, features, type_name, id_col = "ID") {
found <- data %>% filter(!!sym(id_col) %in% features)
if (nrow(found) > 0) {
cat("Found", nrow(found), type_name, "features:\n")
summary <- found %>%
mutate(mean_abundance = rowMeans(select(., -all_of(id_col)), na.rm = TRUE),
total_abundance = rowSums(select(., -all_of(id_col)), na.rm = TRUE),
detection_samples = rowSums(select(., -all_of(id_col)) > 0)) %>%
select(all_of(id_col), mean_abundance, total_abundance, detection_samples) %>%
left_join(enzyme_descriptions, by = setNames("ID", id_col)) %>%
select(all_of(id_col), Description, everything()) %>%
arrange(desc(mean_abundance))
print(summary)
return(list(summary = summary, raw = found))
} else {
cat("No", type_name, "features found.\n")
return(NULL)
}
}
process_enzyme_file <- function(file_path, id_col, target_list, prefix) {
if (file.exists(file_path)) {
data <- read_delim(file_path, delim = "\t", trim_ws = TRUE) %>% rename(!!id_col := 1)
if (id_col == "KO") data$KO <- gsub("ko:", "", data$KO)
for (group in names(target_list)) {
cat("\n---", group, id_col, "---\n")
res <- analyze_features(data, target_list[[group]][[id_col]], paste(group, id_col), id_col)
if (!is.null(res)) {
write.csv(res$summary, paste0("picrust2_output_final/", group, "_", id_col, "_summary.csv"), row.names = FALSE)
write.csv(res$raw, paste0("picrust2_output_final/", group, "_", id_col, "_abundance.csv"), row.names = FALSE)
}
}
} else {
cat("File not found:", file_path, "\n")
}
}
# Pathways
cat("\n--- Pathway Analysis ---\n")
for (group in names(methane_pathways)) {
cat("\nChecking", group, "pathways:\n")
found <- intersect(rownames(abundance), methane_pathways[[group]])
if (length(found) > 0) {
for (pw in found) cat("  -", pw, "(mean:", round(mean(as.numeric(abundance[pw, ]), na.rm=TRUE), 2), ")\n")
} else cat("  None found.\n")
}
# Broad Search
cat("\n--- Broad Keyword Search ---\n")
keywords <- c("methane", "methan", "methyl", "formaldehyde", "formate", "C1")
matches <- unique(grep(paste(keywords, collapse="|"), rownames(abundance), ignore.case=TRUE, value=TRUE))
if (length(matches) > 0) {
cat("Found", length(matches), "related pathways.\n")
res <- data.frame(pathway = matches, mean = rowMeans(abundance[matches,,drop=FALSE], na.rm=TRUE)) %>% arrange(desc(mean))
write.csv(res, "picrust2_output_final/methane_related_pathways.csv", row.names=FALSE)
}
# Enzymes (KO & EC)
process_enzyme_file("picrust2_output_final/KO_metagenome_out/pred_metagenome_unstrat.tsv", "KO", methane_enzymes, "KO")
process_enzyme_file("picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv", "EC", methane_enzymes, "EC")
