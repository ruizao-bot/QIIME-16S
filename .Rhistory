# Remove "Other" taxa
filtered_data <- mapped_data %>%
filter(Plot_Taxon != "Other")
# Check if data exists after filtering
if (nrow(filtered_data) == 0) {
stop("No target species found! Check if taxonomy names in your input file match the mapping logic.")
}
# --- RE-CALCULATE RELATIVE ABUNDANCE ---
# Sum counts by Sample and the NEW Plot_Taxon name
plot_data <- filtered_data %>%
group_by(SampleID, Plot_Taxon) %>%
summarise(Count = sum(Count), .groups = "drop") %>%
group_by(SampleID) %>%
mutate(RelativeAbundance = Count / sum(Count) * 100) %>%
ungroup()
# Add grouping info (Bark/Soil/Wood)
plot_data <- plot_data %>%
mutate(Group = case_when(
grepl("B$", SampleID) ~ "Bark",
grepl("S$", SampleID) ~ "Soil",
TRUE ~ "Wood"
))
# --- DEFINE COLORS (MATCHING OLD REPORT) ---
mob_colors <- c(
"Candidatus Methylacidiphilum" = "#CD5C5C", # IndianRed
"Crenothrix" = "black",
"Methylibium" = "#FF8C00", # DarkOrange
"Methylobacillus" = "#98FB98", # PaleGreen
"Methylobacterium" = "#7FFF00", # Chartreuse
"Methylocella" = "#8B4513", # SaddleBrown
"Methylomonas" = "#E6E6FA", # Lavender/White-ish
"Methylonatrum" = "#483D8B", # DarkSlateBlue
"Methylophaga" = "#800080", # Purple
"Methylopila" = "#C0C0C0", # Silver/Grey
"Methylosinus" = "#DA70D6", # Orchid (Now includes Methylocystis)
"Unclassified Methylophilaceae" = "#AFEEEE" # PaleTurquoise (Now includes Novimethylophilus)
)
# Ensure Factor Levels
plot_data$Plot_Taxon <- factor(plot_data$Plot_Taxon, levels = sort(unique(plot_data$Plot_Taxon)))
# --- PLOTTING ---
p <- ggplot(plot_data, aes(x = SampleID, y = RelativeAbundance, fill = Plot_Taxon)) +
geom_bar(stat = "identity", width = 0.8) +
facet_grid(~ Group, scales = "free_x", space = "free_x") +
# Ensure the Y-axis fits tightly
scale_y_continuous(expand = c(0, 0)) +
# Apply the custom colors
scale_fill_manual(values = mob_colors) +
# Labels and Titles
labs(x = "Tree", y = "Relative abundance (%)", fill = "MOB - 16S") +
# Theme Customization
theme_bw() +
theme(
axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), # Rotated 90 deg for better fit
panel.grid = element_blank(),
strip.background = element_rect(fill = "white", colour = "black"),
strip.text = element_text(size = 12),
legend.position = "right",
legend.text = element_text(size = 10, face = "italic")
)
p
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(RColorBrewer)
setwd("/Users/jiayi/Desktop/metagenomic_pipeline/QIIME")
# Set input and output file paths
input_file <- "denoise_mode/final-table-with-ranks.tsv"
output_plot <- "denoise_mode/stacked_barplot_MOB.pdf"
# Read data
header <- scan(input_file, what = "character", nlines = 1, sep = "\t", quiet = TRUE)
data <- read.table(input_file, sep = "\t", skip = 1, header = FALSE, stringsAsFactors = FALSE)
# Fix column names
if (ncol(data) == length(header) + 1) {
colnames(data) <- c("FeatureID", header)
} else {
colnames(data) <- header
}
# Define metadata and sample columns
metadata_cols <- c("FeatureID", "Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")
sample_cols <- setdiff(colnames(data), metadata_cols)
sample_cols <- setdiff(sample_cols, c("A1", "A2")) # Filter out A1, A2
# Convert to long format
long_data <- data %>%
pivot_longer(cols = all_of(sample_cols), names_to = "SampleID", values_to = "Count") %>%
filter(Count > 0) %>% # Remove zero counts to speed up
mutate(
# 1. Clean Taxonomy: Remove "f__", "g__", etc. and trim whitespace
Family = str_replace_all(Family, "[a-z]__", ""),
Genus = str_replace_all(Genus, "[a-z]__", ""),
Family = trimws(Family),
Genus = trimws(Genus)
)
# --- DEFINING TARGETS ---
# List of Genera to search for (Updated based on your data)
target_genera <- c(
"Methylacidiphilum",
"Crenothrix",
"Methylibium",
"Methylobacillus",
"Methylobacterium",
"Methylocella",
"Methylomonas",
"Methylonatrum",
"Methylophaga",
"Methylopila",
"Methylosinus",
"Methylovirgula"
)
# Create a regex pattern for matching
target_pattern <- paste(target_genera, collapse = "|")
# Filter and label data
filtered_data <- long_data %>%
mutate(
# Extract the matching genus name
MatchedGenus = str_extract(Genus, regex(target_pattern, ignore_case = TRUE)),
# Handle special cases for Unclassified Families
IsUnclassifiedMethylophilaceae = grepl("Methylophilaceae", Family, ignore.case = TRUE) &
(Genus == "" | Genus == "uncultured" | Genus == "Unassigned"),
IsUnclassifiedMethylacidiphilaceae = grepl("Methylacidiphilaceae", Family, ignore.case = TRUE) &
(Genus == "" | Genus == "uncultured" | Genus == "Unassigned")
) %>%
filter(!is.na(MatchedGenus) | IsUnclassifiedMethylophilaceae | IsUnclassifiedMethylacidiphilaceae) %>%
mutate(
Taxon = case_when(
!is.na(MatchedGenus) ~ str_to_title(MatchedGenus),
IsUnclassifiedMethylophilaceae ~ "Unclassified Methylophilaceae",
IsUnclassifiedMethylacidiphilaceae ~ "Unclassified Methylacidiphilaceae"
),
# Add "Candidatus" prefix if needed
Taxon = ifelse(Taxon == "Methylacidiphilum", "Candidatus Methylacidiphilum", Taxon)
)
# Check if we found anything
if (nrow(filtered_data) == 0) {
print("DEBUG: Top 20 Families found in your data (to help debug):")
print(head(sort(table(long_data$Family), decreasing=TRUE), 20))
stop("No target species found! Check the debug output above to see what Families are actually in your data.")
}
# --- RE-CALCULATE RELATIVE ABUNDANCE WITHIN MOB ---
# The reference plot sums to 100%, meaning it shows the proportion WITHIN the Methylotrophs
plot_data <- filtered_data %>%
group_by(SampleID, Taxon) %>%
summarise(Count = sum(Count), .groups = "drop") %>%
group_by(SampleID) %>%
mutate(RelativeAbundance = Count / sum(Count) * 100) %>%
ungroup()
# Add grouping info
plot_data <- plot_data %>%
mutate(Group = case_when(
grepl("B$", SampleID) ~ "Bark",
grepl("S$", SampleID) ~ "Soil",
TRUE ~ "Wood"
))
# Define Colors (Matched to your reference image + New Taxa)
mob_colors <- c(
"Candidatus Methylacidiphilum" = "#CD5C5C", # IndianRed
"Crenothrix" = "black",
"Methylibium" = "#FF8C00", # DarkOrange
"Methylobacillus" = "#98FB98", # PaleGreen
"Methylobacterium" = "#7FFF00", # Chartreuse
"Methylocella" = "#8B4513", # SaddleBrown
"Methylomonas" = "#E6E6FA", # Lavender/White-ish
"Methylonatrum" = "#483D8B", # DarkSlateBlue
"Methylophaga" = "#800080", # Purple
"Methylopila" = "#C0C0C0", # Silver/Grey
"Methylosinus" = "#DA70D6", # Orchid
"Unclassified Methylophilaceae" = "#AFEEEE"  # PaleTurquoise
)
# Ensure factor levels match the legend order (Alphabetical usually)
plot_data$Taxon <- factor(plot_data$Taxon, levels = sort(unique(plot_data$Taxon)))
# Plotting
p <- ggplot(plot_data, aes(x = SampleID, y = RelativeAbundance, fill = Taxon)) +
geom_bar(stat = "identity", width = 0.8) +
facet_grid(~ Group, scales = "free_x", space = "free_x") +
scale_y_continuous(expand = c(0, 0)) +
scale_fill_manual(values = mob_colors) +
labs(x = "Tree", y = "Relative abundance (%)", fill = "MOB - 16S") +
theme_bw() +
theme(
axis.text.x = element_text(angle = 0, hjust = 0.5),
panel.grid = element_blank(),
strip.background = element_rect(fill = "white", colour = "black"),
strip.text = element_text(size = 12),
legend.position = "right",
legend.text = element_text(size = 10, face = "italic")
)
p
library(dplyr)
library(stringr)
# 确保使用的是未过滤的 long_data (也就是包含所有菌的表)
# --- 1. 搜索 Crenothrix ---
cat("\n>>> 正在搜索 Crenothrix 相关踪迹...\n")
crenothrix_check <- long_data %>%
filter(
grepl("Crenothrix", Genus, ignore.case = TRUE) |
grepl("Crenotrichaceae", Family, ignore.case = TRUE)
) %>%
group_by(Family, Genus) %>%
summarise(TotalReads = sum(Count), .groups = 'drop') %>%
arrange(desc(TotalReads))
if(nrow(crenothrix_check) > 0) {
print(crenothrix_check)
} else {
print("未找到任何名为 Crenothrix 的记录！")
}
# --- 2. 搜索 Methylibium (以及近亲 Piscinibacter) ---
cat("\n>>> 正在搜索 Methylibium / Piscinibacter / Burkholderiaceae...\n")
methylibium_check <- long_data %>%
filter(
grepl("Methylibium", Genus, ignore.case = TRUE) |
grepl("Piscinibacter", Genus, ignore.case = TRUE) | # GTDB 中常被改名为此
grepl("Burkholderiaceae", Family, ignore.case = TRUE) # 搜索整个科
) %>%
group_by(Family, Genus) %>%
summarise(TotalReads = sum(Count), .groups = 'drop') %>%
arrange(desc(TotalReads)) %>%
head(20) # 只看这个科里的前20
print(methylibium_check)
library(dplyr)
# change to your own directory
setwd("/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/Scripts")
# Read feature table (ASV counts per sample)
# biom->TSV files usually have:
#  line 1: "# Constructed from biom file"
#  line 2: "#OTU ID\tSample1\tSample2..."
ft_path <- '../denoise_mode/exported-table/feature-table.tsv'
feature_table_lines <- readLines(ft_path)
# Locate the header line that starts with "#OTU ID"
header_idx <- which(grepl('^#OTU ID', feature_table_lines))[1]
if (is.na(header_idx)) {
stop('Could not find header line beginning with "#OTU ID" in feature-table.tsv')
}
# Extract column names from that header (remove leading #)
header_raw <- sub('^#', '', feature_table_lines[header_idx])
col_names <- strsplit(header_raw, '\t')[[1]]
# Fallback: if not tab-delimited for some reason, split on whitespace
if (length(col_names) == 1L) {
col_names <- strsplit(header_raw, '\\s+')[[1]]
}
# Read the data lines after the header line
feature_table <- read.table(ft_path,
sep='\t', header=FALSE, row.names=1,
skip=header_idx, check.names=FALSE,
comment.char='')
# Assign correct column names (skip first column name which is for row names)
if (length(col_names) - 1L != ncol(feature_table)) {
stop(sprintf('Column name count mismatch: header has %d data columns, table has %d',
length(col_names) - 1L, ncol(feature_table)))
}
colnames(feature_table) <- col_names[-1]
# Read taxonomy (Feature ID -> Taxon mapping)
taxonomy <- read.table('../denoise_mode/exported-taxonomy/taxonomy.tsv',
sep='\t', header=TRUE, row.names=1)
# Extract only the Taxon column from taxonomy
taxonomy_only <- data.frame(Taxon = taxonomy$Taxon, row.names = rownames(taxonomy))
# Keep only features that have taxonomy assigned
# Find common feature IDs (preserve feature table order)
common_features <- intersect(rownames(feature_table), rownames(taxonomy_only))
# Subset matched rows
feature_table_matched <- feature_table[common_features, , drop=FALSE]
taxonomy_matched <- taxonomy_only[common_features, , drop=FALSE]
# Merge: add Taxon column as the first column, then all sample counts
merged <- cbind(taxonomy_matched, feature_table_matched)
# Save with proper column names
write.table(merged, '../denoise_mode/taxonomy-abundance-table.tsv',
sep='\t', quote=FALSE, row.names=TRUE)
parse_taxonomy <- function(tax_string) {
ranks <- c(Domain=NA, Phylum=NA, Class=NA, Order=NA, Family=NA, Genus=NA, Species=NA)
if (is.na(tax_string) || tax_string == '') {
ranks[is.na(ranks)] <- 'Unassigned'
return(ranks)
}
parts <- unlist(strsplit(tax_string, ';'))
for (p in parts) {
p <- trimws(p)
if (p == '' ) next
if (!grepl('^[dpcofgs]__', p)) next  # skip unexpected tokens
prefix <- substr(p, 1, 1)
value <- sub('^[dpcofgs]__', '', p)
# Normalize empty or placeholder values
if (value == '' || value == 'uncultured' || value == 'metagenome') value <- 'Unassigned'
rankName <- switch(prefix,
d='Domain', p='Phylum', c='Class', o='Order',
f='Family', g='Genus', s='Species')
ranks[rankName] <- ifelse(value == '', 'Unassigned', value)
}
ranks[is.na(ranks)] <- 'Unassigned'
return(ranks)
}
rank_matrix <- t(vapply(taxonomy_matched$Taxon, parse_taxonomy, character(7)))
rank_df <- as.data.frame(rank_matrix, stringsAsFactors = FALSE)
rownames(rank_df) <- rownames(taxonomy_matched)
merged_ranks <- cbind(rank_df, feature_table_matched)
write.table(merged_ranks, '../denoise_mode/final-table-with-ranks.tsv',
sep='\t', quote=FALSE, row.names=TRUE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(RColorBrewer)
setwd("/Users/jiayi/Desktop/metagenomic_pipeline/QIIME")
# Set input and output file paths
input_file <- "denoise_mode/final-table-with-ranks.tsv"
output_plot <- "denoise_mode/stacked_barplot_MOB.pdf"
# Read data
header <- scan(input_file, what = "character", nlines = 1, sep = "\t", quiet = TRUE)
data <- read.table(input_file, sep = "\t", skip = 1, header = FALSE, stringsAsFactors = FALSE)
# Fix column names
if (ncol(data) == length(header) + 1) {
colnames(data) <- c("FeatureID", header)
} else {
colnames(data) <- header
}
# Define metadata and sample columns
metadata_cols <- c("FeatureID", "Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")
sample_cols <- setdiff(colnames(data), metadata_cols)
sample_cols <- setdiff(sample_cols, c("A1", "A2")) # Filter out A1, A2
# Convert to long format
long_data <- data %>%
pivot_longer(cols = all_of(sample_cols), names_to = "SampleID", values_to = "Count") %>%
filter(Count > 0) %>% # Remove zero counts to speed up
mutate(
# 1. Clean Taxonomy: Remove "f__", "g__", etc. and trim whitespace
Family = str_replace_all(Family, "[a-z]__", ""),
Genus = str_replace_all(Genus, "[a-z]__", ""),
Family = trimws(Family),
Genus = trimws(Genus)
)
# --- DEFINING TARGETS ---
# List of Genera to search for (Updated based on your data)
target_genera <- c(
"Methylacidiphilum",
"Crenothrix",
"Methylibium",
"Methylobacillus",
"Methylobacterium",
"Methylocella",
"Methylomonas",
"Methylonatrum",
"Methylophaga",
"Methylopila",
"Methylosinus",
"Methylovirgula"
)
# Create a regex pattern for matching
target_pattern <- paste(target_genera, collapse = "|")
# Filter and label data
filtered_data <- long_data %>%
mutate(
# Extract the matching genus name
MatchedGenus = str_extract(Genus, regex(target_pattern, ignore_case = TRUE)),
# Handle special cases for Unclassified Families
IsUnclassifiedMethylophilaceae = grepl("Methylophilaceae", Family, ignore.case = TRUE) &
(Genus == "" | Genus == "uncultured" | Genus == "Unassigned"),
IsUnclassifiedMethylacidiphilaceae = grepl("Methylacidiphilaceae", Family, ignore.case = TRUE) &
(Genus == "" | Genus == "uncultured" | Genus == "Unassigned")
) %>%
filter(!is.na(MatchedGenus) | IsUnclassifiedMethylophilaceae | IsUnclassifiedMethylacidiphilaceae) %>%
mutate(
Taxon = case_when(
!is.na(MatchedGenus) ~ str_to_title(MatchedGenus),
IsUnclassifiedMethylophilaceae ~ "Unclassified Methylophilaceae",
IsUnclassifiedMethylacidiphilaceae ~ "Unclassified Methylacidiphilaceae"
),
# Add "Candidatus" prefix if needed
Taxon = ifelse(Taxon == "Methylacidiphilum", "Candidatus Methylacidiphilum", Taxon)
)
# Check if we found anything
if (nrow(filtered_data) == 0) {
print("DEBUG: Top 20 Families found in your data (to help debug):")
print(head(sort(table(long_data$Family), decreasing=TRUE), 20))
stop("No target species found! Check the debug output above to see what Families are actually in your data.")
}
# --- RE-CALCULATE RELATIVE ABUNDANCE WITHIN MOB ---
# The reference plot sums to 100%, meaning it shows the proportion WITHIN the Methylotrophs
plot_data <- filtered_data %>%
group_by(SampleID, Taxon) %>%
summarise(Count = sum(Count), .groups = "drop") %>%
group_by(SampleID) %>%
mutate(RelativeAbundance = Count / sum(Count) * 100) %>%
ungroup()
# Add grouping info
plot_data <- plot_data %>%
mutate(Group = case_when(
grepl("B$", SampleID) ~ "Bark",
grepl("S$", SampleID) ~ "Soil",
TRUE ~ "Wood"
))
# Define Colors (Matched to your reference image + New Taxa)
mob_colors <- c(
"Candidatus Methylacidiphilum" = "#CD5C5C", # IndianRed
"Crenothrix" = "black",
"Methylibium" = "#FF8C00", # DarkOrange
"Methylobacillus" = "#98FB98", # PaleGreen
"Methylobacterium" = "#7FFF00", # Chartreuse
"Methylocella" = "#8B4513", # SaddleBrown
"Methylomonas" = "#E6E6FA", # Lavender/White-ish
"Methylonatrum" = "#483D8B", # DarkSlateBlue
"Methylophaga" = "#800080", # Purple
"Methylopila" = "#C0C0C0", # Silver/Grey
"Methylosinus" = "#DA70D6", # Orchid
"Unclassified Methylophilaceae" = "#AFEEEE"  # PaleTurquoise
)
# Ensure factor levels match the legend order (Alphabetical usually)
plot_data$Taxon <- factor(plot_data$Taxon, levels = sort(unique(plot_data$Taxon)))
# Plotting
p <- ggplot(plot_data, aes(x = SampleID, y = RelativeAbundance, fill = Taxon)) +
geom_bar(stat = "identity", width = 0.8) +
facet_grid(~ Group, scales = "free_x", space = "free_x") +
scale_y_continuous(expand = c(0, 0)) +
scale_fill_manual(values = mob_colors) +
labs(x = "Tree", y = "Relative abundance (%)", fill = "MOB - 16S") +
theme_bw() +
theme(
axis.text.x = element_text(angle = 0, hjust = 0.5),
panel.grid = element_blank(),
strip.background = element_rect(fill = "white", colour = "black"),
strip.text = element_text(size = 12),
legend.position = "right",
legend.text = element_text(size = 10, face = "italic")
)
p
View(filtered_data)
View(long_data)
library(dplyr)
# 假设你的原始数据表叫 long_data
cat("\n>>> 正在寻找失踪人口...\n")
# 1. 找 Methylosinus 的替身 (Methylocystis)
check_purple <- long_data %>%
filter(grepl("Methylocystis", Genus, ignore.case = TRUE) |
grepl("Methylosinus", Genus, ignore.case = TRUE)) %>%
group_by(Genus) %>%
summarise(TotalReads = sum(Count))
print("--- 紫色条带去哪了？(Type II MOB) ---")
print(check_purple)
# 2. 找 Methylibium 的尸体 (如果有的话)
check_orange <- long_data %>%
filter(grepl("Methylibium", Genus, ignore.case = TRUE) |
grepl("Piscinibacter", Genus, ignore.case = TRUE)) %>%
group_by(Genus) %>%
summarise(TotalReads = sum(Count))
print("--- 橙色条带去哪了？(Methylibium) ---")
print(check_orange)
library(dplyr)
# 1. 搜寻“紫色隐形人”：只看科 (Family)，不看属
check_family <- long_data %>%
filter(grepl("Methylocystaceae", Family, ignore.case = TRUE)) %>%
group_by(Family, Genus) %>%
summarise(TotalReads = sum(Count)) %>%
arrange(desc(TotalReads))
print("--- 它们是不是卡在科级别了？(Methylocystaceae) ---")
print(check_family)
library(dplyr)
# 检查是否卡在科级别
check_family <- long_data %>%
filter(grepl("Methylocystaceae", Family, ignore.case = TRUE)) %>%
group_by(Family, Genus) %>%
summarise(TotalReads = sum(Count)) %>%
arrange(desc(TotalReads))
print(check_family)
library(dplyr)
# 找出那个占据了灰色区域的“神秘人”
# 假设你的未过滤数据叫 long_data
who_is_grey <- long_data %>%
# 排除掉你已经画出来的那些名字
filter(!Genus %in% c("Crenothrix", "Methylobacillus", "Methylobacterium",
"Methylocella", "Methylophaga", "Methylosinus",
"Novimethylophilus", "Methylibium")) %>%
# 统计剩余物种的丰度
group_by(Family, Genus) %>%
summarise(TotalReads = sum(Count)) %>%
arrange(desc(TotalReads)) %>%
head(10)
print("--- 谁藏在灰色条带里？(Top 10 Unknowns) ---")
print(who_is_grey)
library(dplyr)
library(tidyr)
# --- 步骤 1: 数据清洗 (去除植物污染) ---
clean_data <- long_data %>%
# 去除叶绿体 (Chloroplast) 和 线粒体 (Mitochondria)
filter(!grepl("Chloroplast", Family, ignore.case = TRUE)) %>%
filter(!grepl("Mitochondria", Family, ignore.case = TRUE)) %>%
filter(!grepl("Chloroplast", Genus, ignore.case = TRUE)) %>%
filter(!grepl("Mitochondria", Genus, ignore.case = TRUE)) %>%
# 去除完全未分类的 (通常是噪音)
filter(Family != "Unassigned" & Genus != "Unassigned")
# --- 步骤 2: 最终搜救 (在清洗后的数据里找目标) ---
cat("\n>>> 正在清洗后的数据中搜索目标...\n")
# 找紫色 (Type II)
target_purple <- clean_data %>%
filter(grepl("Methylocyst", Family, ignore.case = TRUE) |
grepl("Methylosinus", Genus, ignore.case = TRUE)) %>%
summarise(TotalReads = sum(Count))
# 找橙色 (Methylibium)
target_orange <- clean_data %>%
filter(grepl("Methylibium", Genus, ignore.case = TRUE) |
grepl("Burkholderiaceae", Family, ignore.case = TRUE)) %>%
summarise(TotalReads = sum(Count))
print(paste("清洗后紫色 (Methylosinus) Reads数:", target_purple$TotalReads))
print(paste("清洗后橙色 (Methylibium) Reads数:", target_orange$TotalReads))
# --- 步骤 3: 重新查看 Top 10 (看看现在谁是老大) ---
top_clean <- clean_data %>%
filter(!Genus %in% c("Crenothrix", "Methylobacillus", "Methylobacterium",
"Methylocella", "Methylophaga", "Novimethylophilus")) %>%
group_by(Family, Genus) %>%
summarise(TotalReads = sum(Count)) %>%
arrange(desc(TotalReads)) %>%
head(10)
print("--- 去除植物后的灰色条带主要成分 ---")
print(top_clean)
