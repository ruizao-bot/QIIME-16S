print(fit_diagnostics)
# 设置统一 y 轴范围
y_min <- min(df_surv$log10_Abundance, na.rm = TRUE)
y_max <- max(df_surv$log10_Abundance, na.rm = TRUE)
# 保存拼图结果
plots <- list()
for (comm in c("1", "2", "3")) {
df_i <- df_surv %>% filter(Community == comm)
# 主图：CUE vs log10(Abundance)
p_main <- ggplot(df_i, aes(x = Species_CUE, y = log10_Abundance)) +
geom_point(color = pal_rgb[comm], alpha = 0.3) +
geom_smooth(method = "lm", se = TRUE, color = pal_rgb[comm], linewidth = 1) +
ylim(y_min, y_max) +
labs(x = "Species-level CUE", y = expression(log[10](Abundance))) +
base_theme
# 侧边直方图
p_hist <- ggplot(df_i, aes(x = log10_Abundance)) +
geom_histogram(bins = 50, fill = pal_rgb[comm], alpha = 0.3, color = pal_rgb[comm]) +
xlim(y_min, y_max) +
coord_flip() +
scale_y_reverse() +
labs(x = "Frequency", y = NULL) +
base_theme +
theme(
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.major.y = element_blank(),
plot.margin = margin(5, 5, 5, 5)
)
p_combo <- p_hist + p_main + plot_layout(widths = c(1.2, 3))
plots[[comm]] <- p_combo
}
# 纵向排列 3 个社区图
final_plot <- wrap_plots(plots, ncol = 1) & base_theme
final_plot
# 4. Niche overlap vs CUE
p_cosine_cue <- ggplot(df, aes(x = Competition, y = Community_CUE, color = factor(Community),shape = factor(Community))) +
geom_point(size = 2, alpha = 0.7) +
geom_smooth(method = "lm", se = TRUE, aes(group = factor(Community), color = factor(Community))) +
scale_color_manual(values = pal_rgb, name = "Community") +
labs(
x = "Uptake Cosine Similarity",
y = "Community CUE",
color = "Community"
) +
base_theme+
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15), name = "Community")
print(p_cosine_cue)
#!/usr/bin/env Rscript
# b_analysis.R (simplified, ggplot2-based output like thesis.R)
library(ggplot2)
library(dplyr)
library(Cairo)
library(patchwork)
# Read data and set output directory
df <- read.csv("/Users/jiayi/Desktop/micrm/master_project/results/b_analysis.csv")
results_dir <- "/Users/jiayi/Desktop/micrm/master_project/results"
cat("Data loaded. Rows:", nrow(df), ", Columns:", ncol(df), "\n\n")
# Palette and theme (match thesis.R styling)
pal_rgb <- c("1" = "#E74C3C",   # 红
"2" = "#2ECC71",   # 绿
"3" = "#3498DB")   # 蓝
base_theme <- theme_minimal(base_size = 12) +
theme(
text       = element_text(family = "Times New Roman", size = 12),
axis.text  = element_text(family = "Times New Roman", size = 12),
axis.title = element_text(family = "Times New Roman", size = 12),
legend.text = element_text(family = "Times New Roman", size = 12),
legend.title = element_text(family = "Times New Roman", size = 12),
plot.title = element_text(family = "Times New Roman", size = 12),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border     = element_rect(color = "black", fill = NA, size = 0.5),
axis.ticks       = element_line(color = "black", size = 0.3)
)
# Helper: reshape wide columns (1/2/3) to long for plotting
make_long <- function(df, prefix_x, prefix_y, suffix_x = "", suffix_y = "", names = c("1","2","3")){
n <- nrow(df)
data.frame(
Community = factor(rep(names, each = n), levels = names),
x = c(df[[paste0(prefix_x, names[1], suffix_x)]], df[[paste0(prefix_x, names[2], suffix_x)]], df[[paste0(prefix_x, names[3], suffix_x)]]),
y = c(df[[paste0(prefix_y, names[1], suffix_y)]], df[[paste0(prefix_y, names[2], suffix_y)]], df[[paste0(prefix_y, names[3], suffix_y)]])
)
}
# 1) Facilitation vs CUE (ggplot) ------------------------------------------
feed_df <- make_long(df, prefix_x = "L_eff", prefix_y = "CUE", suffix_x = "_sum")
p_feed <- ggplot(feed_df, aes(x = x, y = y, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "Facilitation", y = "CUE",color = "Community", shape = "Community") +
base_theme
p_feed
ggsave(filename = file.path(results_dir, "CUE_vs_Facilitation.pdf"), plot = p_feed,
device = cairo_pdf, width = 21, height = 12, units = "cm", dpi = 600, bg = "white")
# 2) Competition vs CUE (ggplot) --------------------------------------------
comp_df <- make_long(df, prefix_x = "Competition", prefix_y = "CUE")
p_comp <- ggplot(comp_df, aes(x = x, y = y, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1"=16,"2"=17,"3"=15)) +
scale_x_continuous(
breaks = pretty(range(comp_df$x, na.rm = TRUE), n = 4),
limits = range(comp_df$x, na.rm = TRUE)
) +
labs(x = "Competition", y = "CUE", color = "Community", shape = "Community") +
base_theme
p_comp
ggsave(filename = file.path(results_dir, "CUE_vs_Competition.pdf"), plot = p_comp,
device = cairo_pdf, width = 21, height = 12, units = "cm", dpi = 600, bg = "white")
p_feed2 <- p_feed + labs(title = "")
p_comp2 <- p_comp +
scale_x_continuous(breaks = pretty(comp_df$x, n = 3))
p_combined <- (p_feed2 + p_comp2) +
plot_layout(ncol = 2, guides = "collect") &
theme(
legend.position = "right",          # 图例放右侧
)
p_combined
ggsave(
filename = file.path(results_dir, "CUE_vs_Facilitation_Competition.pdf"),
plot = p_combined,
device = cairo_pdf, width = 21, height = 10, units = "cm",
dpi = 600, bg = "white"
)
# Keep regression summaries (computed but not plotted)
lm_f1 <- lm(CUE1 ~ L_eff1_sum, data=df)
lm_f2 <- lm(CUE2 ~ L_eff2_sum, data=df)
lm_f3 <- lm(CUE3 ~ L_eff3_sum, data=df)
lm_c1 <- lm(CUE1 ~ Competition1, data=df)
lm_c2 <- lm(CUE2 ~ Competition2, data=df)
lm_c3 <- lm(CUE3 ~ Competition3, data=df)
cat("--- Facilitation regressions ---\n")
cat("Community 1:\n"); print(summary(lm_f1))
cat("Community 2:\n"); print(summary(lm_f2))
cat("Community 3:\n"); print(summary(lm_f3))
cat("--- Competition regressions ---\n")
cat("Community 1:\n"); print(summary(lm_c1))
cat("Community 2:\n"); print(summary(lm_c2))
cat("Community 3:\n"); print(summary(lm_c3))
# Check column names to debug
cat("\nColumn names in df:\n")
print(colnames(df))
# 3) b vs Competition (ggplot) --------------------------------------------
# Create long format manually since b column doesn't have 1/2/3 suffix
comp_b_df <- data.frame(
Community = factor(rep(c("1", "2", "3"), each = nrow(df)), levels = c("1", "2", "3")),
b = rep(df$b, 3),
Competition = c(df$Competition1, df$Competition2, df$Competition3)
)
p_b_comp <- ggplot(comp_b_df, aes(x = b, y = Competition, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "b", y = "Competition", color = "Community", shape = "Community") +
base_theme
print(p_b_comp)
ggsave(filename = file.path(results_dir, "b_vs_Competition.pdf"), plot = p_b_comp,
device = cairo_pdf, width = 21, height = 12, units = "cm", dpi = 600, bg = "white")
# 4) b vs Cooperation/Facilitation (ggplot) -------------------------------
coop_b_df <- data.frame(
Community = factor(rep(c("1", "2", "3"), each = nrow(df)), levels = c("1", "2", "3")),
b = rep(df$b, 3),
L_eff_sum = c(df$L_eff1_sum, df$L_eff2_sum, df$L_eff3_sum)
)
p_b_coop <- ggplot(coop_b_df, aes(x = b, y = L_eff_sum, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "b", y = "Cooperation", color = "Community", shape = "Community") +
base_theme
print(p_b_coop)
ggsave(filename = file.path(results_dir, "b_vs_Facilitation.pdf"), plot = p_b_coop,
device = cairo_pdf, width = 21, height = 12, units = "cm", dpi = 600, bg = "white")
# 5) Combined b plots (competition and cooperation side by side) ----------
p_b_combined <- (p_b_comp + p_b_coop) +
plot_layout(ncol = 2, guides = "collect") &
theme(legend.position = "right")
print(p_b_combined)
ggsave(filename = file.path(results_dir, "b_vs_Competition_Facilitation.pdf"),
plot = p_b_combined,
device = cairo_pdf, width = 28, height = 12, units = "cm", dpi = 600, bg = "white")
# 6) Four-panel combined figure (b vs competition, b vs facilitation, competition vs CUE, facilitation vs CUE)
# Arrange as 2x2 and collect a single legend on the right
p_top_left <- p_b_comp + labs(title = "")
p_top_right <- p_b_coop + labs(title = "")
p_bottom_left <- p_comp + labs(title = "")
p_bottom_right <- p_feed + labs(title = "")
p_4panel <- (p_top_left | p_top_right) / (p_bottom_left | p_bottom_right) +
plot_layout(guides = "collect") &
theme(legend.position = "right")
print(p_4panel)
#!/usr/bin/env Rscript
# b_analysis.R (simplified, ggplot2-based output like thesis.R)
library(ggplot2)
library(dplyr)
library(Cairo)
library(patchwork)
# Read data and set output directory
df <- read.csv("/Users/jiayi/Desktop/micrm/master_project/results/b_analysis.csv")
results_dir <- "/Users/jiayi/Desktop/micrm/master_project/results"
cat("Data loaded. Rows:", nrow(df), ", Columns:", ncol(df), "\n\n")
# Palette and theme (match thesis.R styling)
pal_rgb <- c("1" = "#E74C3C",   # 红
"2" = "#2ECC71",   # 绿
"3" = "#3498DB")   # 蓝
base_theme <- theme_minimal(base_size = 12) +
theme(
text       = element_text(family = "Times New Roman", size = 12),
axis.text  = element_text(family = "Times New Roman", size = 12),
axis.title = element_text(family = "Times New Roman", size = 12),
legend.text = element_text(family = "Times New Roman", size = 12),
legend.title = element_text(family = "Times New Roman", size = 12),
plot.title = element_text(family = "Times New Roman", size = 12),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border     = element_rect(color = "black", fill = NA, size = 0.5),
axis.ticks       = element_line(color = "black", size = 0.3)
)
# Helper: reshape wide columns (1/2/3) to long for plotting
make_long <- function(df, prefix_x, prefix_y, suffix_x = "", suffix_y = "", names = c("1","2","3")){
n <- nrow(df)
data.frame(
Community = factor(rep(names, each = n), levels = names),
x = c(df[[paste0(prefix_x, names[1], suffix_x)]], df[[paste0(prefix_x, names[2], suffix_x)]], df[[paste0(prefix_x, names[3], suffix_x)]]),
y = c(df[[paste0(prefix_y, names[1], suffix_y)]], df[[paste0(prefix_y, names[2], suffix_y)]], df[[paste0(prefix_y, names[3], suffix_y)]])
)
}
# 1) L_eff vs CUE (ggplot) ------------------------------------------
# Note: L_eff_sum now excludes diagonal elements (cross-feeding only)
feed_df <- make_long(df, prefix_x = "L_eff", prefix_y = "CUE", suffix_x = "_sum")
p_feed <- ggplot(feed_df, aes(x = x, y = y, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "L_eff (no diagonal)", y = "CUE", color = "Community", shape = "Community") +
base_theme
p_feed
#!/usr/bin/env Rscript
# b_analysis.R (simplified, ggplot2-based output like thesis.R)
library(ggplot2)
library(dplyr)
library(Cairo)
library(patchwork)
# Read data and set output directory
df <- read.csv("/Users/jiayi/Desktop/micrm/master_project/results/b_analysis.csv")
results_dir <- "/Users/jiayi/Desktop/micrm/master_project/results"
cat("Data loaded. Rows:", nrow(df), ", Columns:", ncol(df), "\n\n")
# Palette and theme (match thesis.R styling)
pal_rgb <- c("1" = "#E74C3C",   # 红
"2" = "#2ECC71",   # 绿
"3" = "#3498DB")   # 蓝
base_theme <- theme_minimal(base_size = 12) +
theme(
text       = element_text(family = "Times New Roman", size = 12),
axis.text  = element_text(family = "Times New Roman", size = 12),
axis.title = element_text(family = "Times New Roman", size = 12),
legend.text = element_text(family = "Times New Roman", size = 12),
legend.title = element_text(family = "Times New Roman", size = 12),
plot.title = element_text(family = "Times New Roman", size = 12),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border     = element_rect(color = "black", fill = NA, size = 0.5),
axis.ticks       = element_line(color = "black", size = 0.3)
)
# Helper: reshape wide columns (1/2/3) to long for plotting
make_long <- function(df, prefix_x, prefix_y, suffix_x = "", suffix_y = "", names = c("1","2","3")){
n <- nrow(df)
data.frame(
Community = factor(rep(names, each = n), levels = names),
x = c(df[[paste0(prefix_x, names[1], suffix_x)]], df[[paste0(prefix_x, names[2], suffix_x)]], df[[paste0(prefix_x, names[3], suffix_x)]]),
y = c(df[[paste0(prefix_y, names[1], suffix_y)]], df[[paste0(prefix_y, names[2], suffix_y)]], df[[paste0(prefix_y, names[3], suffix_y)]])
)
}
# 1) C_feed (Cooperation) vs CUE (ggplot) ------------------------------------------
# C_feed represents cross-feeding cooperation (L_eff with diagonal removed)
coop_df <- make_long(df, prefix_x = "C_feed", prefix_y = "CUE")
p_coop <- ggplot(coop_df, aes(x = x, y = y, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "Cooperation (C_feed)", y = "CUE", color = "Community", shape = "Community") +
base_theme
ggsave(filename = file.path(results_dir, "CUE_vs_Cooperation.pdf"), plot = p_coop,
device = cairo_pdf, width = 21, height = 12, units = "cm", dpi = 600, bg = "white")
# 2) Competition vs CUE (ggplot) --------------------------------------------
comp_df <- make_long(df, prefix_x = "Competition", prefix_y = "CUE")
p_comp <- ggplot(comp_df, aes(x = x, y = y, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1"=16,"2"=17,"3"=15)) +
scale_x_continuous(
breaks = pretty(range(comp_df$x, na.rm = TRUE), n = 4),
limits = range(comp_df$x, na.rm = TRUE)
) +
labs(x = "Competition", y = "CUE", color = "Community", shape = "Community") +
base_theme
p_comp
# 3) b vs Competition (ggplot) --------------------------------------------
# Create long format manually since b column doesn't have 1/2/3 suffix
comp_b_df <- data.frame(
Community = factor(rep(c("1", "2", "3"), each = nrow(df)), levels = c("1", "2", "3")),
b = rep(df$b, 3),
Competition = c(df$Competition1, df$Competition2, df$Competition3)
)
p_b_comp <- ggplot(comp_b_df, aes(x = b, y = Competition, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "b", y = "Competition", color = "Community", shape = "Community") +
base_theme
print(p_b_comp)
# 4) b vs Cooperation/Facilitation (ggplot) -------------------------------
coop_b_df <- data.frame(
Community = factor(rep(c("1", "2", "3"), each = nrow(df)), levels = c("1", "2", "3")),
b = rep(df$b, 3),
L_eff_sum = c(df$L_eff1_sum, df$L_eff2_sum, df$L_eff3_sum)
)
p_b_coop <- ggplot(coop_b_df, aes(x = b, y = L_eff_sum, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "b", y = "Cooperation", color = "Community", shape = "Community") +
base_theme
print(p_b_coop)
p_coop
# 4) b vs Cooperation/Facilitation (ggplot) -------------------------------
coop_b_df <- data.frame(
Community = factor(rep(c("1", "2", "3"), each = nrow(df)), levels = c("1", "2", "3")),
b = rep(df$b, 3),
L_eff_sum = c(df$L_eff1_sum, df$L_eff2_sum, df$L_eff3_sum)
)
p_b_coop <- ggplot(coop_b_df, aes(x = b, y = L_eff_sum, color = Community, shape = Community)) +
geom_point(alpha = 0.8, size = 1.8) +
scale_color_manual(values = pal_rgb) +
scale_shape_manual(values = c("1" = 16, "2" = 17, "3" = 15)) +
labs(x = "b", y = "Cooperation", color = "Community", shape = "Community") +
base_theme
print(p_b_coop)
# PICRUSt2 Targeted Abundance Extraction
library(readr)
library(tidyverse)
library(dplyr)
# ---------------------------------------------------------
# 1. Setup & Data Loading
# ---------------------------------------------------------
# Load metadata and pathway abundance
abundance_file <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/picrust2_output_final/pathways_out/path_abun_unstrat.tsv"
metadata_file <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/Data/metadata/metadata.tsv"
# Read data
metadata <- read_delim(metadata_file, delim = "\t", trim_ws = TRUE)
abundance <- read_delim(abundance_file, delim = "\t", trim_ws = TRUE) %>%
column_to_rownames(var = colnames(.)[1])
# Filter samples to match metadata
clean_metadata <- metadata %>% filter(control_status == "sample")
common_samples <- intersect(colnames(abundance), clean_metadata$`sample-id`)
abundance <- abundance %>% select(all_of(common_samples))
cat("Loaded data: ", ncol(abundance), "samples.\n")
# ---------------------------------------------------------
# 1. Setup & Data Loading
# ---------------------------------------------------------
# Load metadata and pathway abundance
abundance_file <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/picrust2_output_final/pathways_out/path_abun_unstrat.tsv"
metadata_file <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME/Data/metadata/metadata.tsv"
# Read data
metadata <- read_delim(metadata_file, delim = "\t", trim_ws = TRUE)
abundance <- read_delim(abundance_file, delim = "\t", trim_ws = TRUE) %>%
column_to_rownames(var = colnames(.)[1])
# Filter samples to match metadata
clean_metadata <- metadata %>% filter(control_status == "sample")
common_samples <- intersect(colnames(abundance), clean_metadata$`sample-id`)
abundance <- abundance %>% dplyr::select(dplyr::all_of(common_samples))
cat("Loaded data: ", ncol(abundance), "samples.\n")
# ---------------------------------------------------------
# 2. Define Targets
# ---------------------------------------------------------
methane_pathways <- list(
methanogenesis = c("METHANOGENESIS-PWY", "PWY-7084", "PWY-5173", "PWY-7255", "METHGLYUT-PWY"),
methanotroph = c("METHANE-OXIDATION-PWY", "PWY-7357", "FORMALDEHYDE-OXIDATION-PWY", "PWY-7013")
)
methane_enzymes <- list(
methanogenesis = list(
EC = c("2.8.4.1", "1.12.98.1", "2.1.1.86", "1.2.7.4", "2.3.1.101"),
KO = c("K00399", "K00401", "K00402", "K00577", "K00578", "K00579", "K00580", "K00581", "K00582", "K00583", "K00584", "K00200", "K00201", "K00202", "K00672", "K01499")
),
methanotroph = list(
EC = c("1.14.13.25", "1.14.18.3", "1.1.1.1", "1.2.1.46", "1.1.2.7"),
KO = c("K10944", "K10945", "K10946", "K16157", "K16158", "K16159", "K14028", "K14029", "K00121", "K00122", "K08691")
)
)
# ---------------------------------------------------------
# 3. Annotation Database (for descriptions)
# ---------------------------------------------------------
ensure_file <- function(url, file_path) {
if (!file.exists(file_path)) {
cat("Downloading:", file_path, "...\n")
tryCatch(download.file(url, file_path, method = "auto"), error = function(e) cat("Download failed:", url, "\n"))
}
}
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ko_info.tsv.gz", "picrust2_output_final/ko_info.tsv.gz")
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ec_level4_info.tsv.gz", "picrust2_output_final/ec_level4_info.tsv.gz")
load_desc <- function(path) if(file.exists(path)) read_tsv(path, col_names = c("ID", "Description"), col_types = "cc") else data.frame(ID=character(), Description=character())
enzyme_descriptions <- bind_rows(load_desc("picrust2_output_final/ko_info.tsv.gz"), load_desc("picrust2_output_final/ec_level4_info.tsv.gz")) %>%
mutate(ID = gsub("^EC:", "", ID), ID = gsub("^ko:", "", ID))
cat("Loaded", nrow(enzyme_descriptions), "enzyme descriptions (KO + EC)\n")
# ---------------------------------------------------------
# 1. Setup & Data Loading
# ---------------------------------------------------------
# Set base directory
base_dir <- "/Users/jiayi/Desktop/metagenomic_pipeline/QIIME"
setwd(base_dir)
# Load metadata and pathway abundance
abundance_file <- file.path(base_dir, "picrust2_output_final/pathways_out/path_abun_unstrat.tsv")
metadata_file <- file.path(base_dir, "Data/metadata/metadata.tsv")
# Read data
metadata <- read_delim(metadata_file, delim = "\t", trim_ws = TRUE)
abundance <- read_delim(abundance_file, delim = "\t", trim_ws = TRUE) %>%
column_to_rownames(var = colnames(.)[1])
# Filter samples to match metadata
clean_metadata <- metadata %>% filter(control_status == "sample")
common_samples <- intersect(colnames(abundance), clean_metadata$`sample-id`)
abundance <- abundance %>% dplyr::select(dplyr::all_of(common_samples))
cat("Loaded data: ", ncol(abundance), "samples.\n")
# ---------------------------------------------------------
# 2. Define Targets
# ---------------------------------------------------------
methane_pathways <- list(
methanogenesis = c("METHANOGENESIS-PWY", "PWY-7084", "PWY-5173", "PWY-7255", "METHGLYUT-PWY"),
methanotroph = c("METHANE-OXIDATION-PWY", "PWY-7357", "FORMALDEHYDE-OXIDATION-PWY", "PWY-7013")
)
methane_enzymes <- list(
methanogenesis = list(
EC = c("2.8.4.1", "1.12.98.1", "2.1.1.86", "1.2.7.4", "2.3.1.101"),
KO = c("K00399", "K00401", "K00402", "K00577", "K00578", "K00579", "K00580", "K00581", "K00582", "K00583", "K00584", "K00200", "K00201", "K00202", "K00672", "K01499")
),
methanotroph = list(
EC = c("1.14.13.25", "1.14.18.3", "1.1.1.1", "1.2.1.46", "1.1.2.7"),
KO = c("K10944", "K10945", "K10946", "K16157", "K16158", "K16159", "K14028", "K14029", "K00121", "K00122", "K08691")
)
)
# ---------------------------------------------------------
# 3. Annotation Database (for descriptions)
# ---------------------------------------------------------
ensure_file <- function(url, file_path) {
if (!file.exists(file_path)) {
cat("Downloading:", file_path, "...\n")
tryCatch(download.file(url, file_path, method = "auto"), error = function(e) cat("Download failed:", url, "\n"))
}
}
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ko_info.tsv.gz", "picrust2_output_final/ko_info.tsv.gz")
ensure_file("https://raw.githubusercontent.com/picrust/picrust2/master/picrust2/default_files/description_mapfiles/ec_level4_info.tsv.gz", "picrust2_output_final/ec_level4_info.tsv.gz")
load_desc <- function(path) if(file.exists(path)) read_tsv(path, col_names = c("ID", "Description"), col_types = "cc") else data.frame(ID=character(), Description=character())
enzyme_descriptions <- bind_rows(load_desc("picrust2_output_final/ko_info.tsv.gz"), load_desc("picrust2_output_final/ec_level4_info.tsv.gz")) %>%
mutate(ID = gsub("^EC:", "", ID), ID = gsub("^ko:", "", ID))
cat("Loaded", nrow(enzyme_descriptions), "enzyme descriptions (KO + EC)\n")
# Manual additions
manual_desc <- data.frame(
ID = c("2.1.1.21"),
Description = c("N5-methyltetrahydromethanopterin:coenzyme M methyltransferase (transferred to 2.1.1.86)"),
stringsAsFactors = FALSE
)
enzyme_descriptions <- bind_rows(enzyme_descriptions, manual_desc)
# ---------------------------------------------------------
# 4. Processing Functions
# ---------------------------------------------------------
save_abundance <- function(data, features, type_name, id_col, output_prefix) {
# Filter data
found_data <- data %>% filter(!!sym(id_col) %in% features)
if (nrow(found_data) > 0) {
# Add descriptions if available
found_data_desc <- found_data %>%
left_join(enzyme_descriptions, by = setNames("ID", id_col)) %>%
dplyr::select(dplyr::all_of(id_col), Description, everything())
# Report matching statistics
n_matched <- sum(!is.na(found_data_desc$Description))
cat("  ", n_matched, "/", nrow(found_data_desc), id_col, "entries matched with descriptions\n")
# Save
outfile <- paste0("picrust2_output_final/", output_prefix, "_abundance.csv")
write.csv(found_data_desc, outfile, row.names = FALSE)
cat("Saved:", outfile, "(", nrow(found_data), "features )\n")
} else {
cat("No features found for", output_prefix, "\n")
}
}
process_enzyme_file <- function(file_path, id_col, target_list) {
if (file.exists(file_path)) {
cat("\nProcessing", file_path, "...\n")
data <- read_delim(file_path, delim = "\t", trim_ws = TRUE) %>% rename(!!id_col := 1)
if (id_col == "KO") data$KO <- gsub("ko:", "", data$KO)
for (group in names(target_list)) {
save_abundance(data, target_list[[group]][[id_col]], group, id_col, paste0(group, "_", id_col))
}
} else {
cat("File not found:", file_path, "\n")
}
}
# 1. Pathways
cat("\n--- Extracting Pathways ---\n")
pathway_df <- abundance %>% rownames_to_column("Pathway")
for (group in names(methane_pathways)) {
found_pathways <- pathway_df %>% filter(Pathway %in% methane_pathways[[group]])
if (nrow(found_pathways) > 0) {
outfile <- paste0("picrust2_output_final/", group, "_pathways_abundance.csv")
write.csv(found_pathways, outfile, row.names = FALSE)
cat("Saved:", outfile, "\n")
}
}
# 2. Enzymes (KO & EC)
cat("\n--- Extracting Enzymes ---\n")
process_enzyme_file("picrust2_output_final/KO_metagenome_out/pred_metagenome_unstrat.tsv", "KO", methane_enzymes)
process_enzyme_file("picrust2_output_final/EC_metagenome_out/pred_metagenome_unstrat.tsv", "EC", methane_enzymes)
cat("\nDone.\n")
