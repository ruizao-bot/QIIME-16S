}
pheatmap::pheatmap(
heat_data_log,
cluster_rows = TRUE,
cluster_cols = cluster_samples,
annotation_col = annotation_col,
annotation_colors = annotation_colors,
color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
fontsize = 8,
fontsize_row = 7,
fontsize_col = 8,
main = paste("Top", top_n, "Taxa Heatmap -", dataset_name, "\n[log10(Relative Abundance %)]"),
filename = paste0(output_prefix, "_taxa_heatmap.pdf"),
width = 10,
height = 12
)
}
plot_heatmap(genus_abund, meta, top_n = 30, group_var = "sample_type")
cat("Heatmap saved\n")
# Alpha diversity
alpha_div <- data.frame(
Sample = colnames(ft),
Observed = colSums(ft > 0),
Shannon = vegan::diversity(t(ft), index = "shannon"),
Simpson = vegan::diversity(t(ft), index = "simpson")
)
alpha_div <- cbind(alpha_div, meta[alpha_div$Sample, ])
alpha_long <- alpha_div %>%
pivot_longer(cols = c(Observed, Shannon, Simpson), names_to = "Metric", values_to = "Value")
p_alpha <- ggplot(alpha_long, aes(x = sample_type, y = Value, fill = sample_type)) +
geom_boxplot() +
facet_wrap(~ Metric, scales = "free_y") +
theme_bw() +
labs(title = paste("Alpha Diversity -", dataset_name), x = "Sample Type", y = "Value") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(p_alpha)
ggsave(paste0(output_prefix, "_alpha_diversity_boxplot.pdf"), p_alpha, width = 10, height = 4)
cat("Alpha diversity boxplot saved\n")
# PCoA ordination using Unweighted UniFrac from QIIME2
cat("\n=== PCoA with Unweighted UniFrac ===\n")
unweighted_pcoa_file <- "Results/denoise_mode/diversity/exported-unweighted_unifrac-pcoa/ordination.txt"
unweighted_dist_file <- "Results/denoise_mode/diversity/exported-unweighted_unifrac/distance-matrix.tsv"
# Parse QIIME2 ordination file
lines <- readLines(unweighted_pcoa_file)
prop_idx <- grep("^Proportion", lines)
site_idx <- grep("^Site", lines)
percent_var <- round(as.numeric(lines[(prop_idx + 1):(site_idx - 1)]) * 100, 2)
coord_lines <- lines[(site_idx + 1):length(lines)]
coord_lines <- coord_lines[coord_lines != ""]
coord_matrix <- do.call(rbind, strsplit(coord_lines, "\\t"))
pcoa_scores <- data.frame(
Sample = coord_matrix[, 1],
PC1 = as.numeric(coord_matrix[, 2]),
PC2 = as.numeric(coord_matrix[, 3]),
stringsAsFactors = FALSE
)
rownames(pcoa_scores) <- pcoa_scores$Sample
# Only keep samples that exist in metadata
common_samples <- intersect(pcoa_scores$Sample, rownames(meta))
pcoa_scores <- pcoa_scores[common_samples, ]
pcoa_scores <- cbind(pcoa_scores, meta[pcoa_scores$Sample, ])
# Read distance matrix for PERMANOVA
unifrac_dist_data <- read.table(unweighted_dist_file, sep = "\t", header = TRUE, row.names = 1)
unifrac_dist_data <- unifrac_dist_data[common_samples, common_samples]
pcoa_dist <- as.dist(unifrac_dist_data)
cat("Using QIIME2 Unweighted UniFrac results\n")
# PERMANOVA analysis
cat("\n=== PERMANOVA Analysis ===\n")
# Ensure metadata matches distance matrix samples
dist_samples <- labels(pcoa_dist)
meta_subset <- meta[dist_samples, ]
# Run tests
if (length(unique(meta_subset$species)) > 1) {
permanova_species <- adonis2(pcoa_dist ~ species, data = meta_subset, permutations = 999)
cat("\n1. Tree Species Effect:\n")
print(permanova_species)
}
if (length(unique(meta_subset$sample_type)) > 1) {
permanova_tissue <- adonis2(pcoa_dist ~ sample_type, data = meta_subset, permutations = 999)
cat("\n2. Tissue Effect:\n")
print(permanova_tissue)
}
if (length(unique(meta_subset$species)) > 1 && length(unique(meta_subset$sample_type)) > 1) {
permanova_combined <- adonis2(pcoa_dist ~ species + sample_type, data = meta_subset, permutations = 999)
cat("\n3. Combined Effect:\n")
print(permanova_combined)
permanova_interaction <- adonis2(pcoa_dist ~ species * sample_type, data = meta_subset, permutations = 999)
cat("\n4. Interaction Effect:\n")
print(permanova_interaction)
}
# Save results
sink(paste0(output_prefix, "_PERMANOVA_results.txt"))
cat("PERMANOVA Test Results -", dataset_name, "\n")
cat("Date:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("Distance metric: Unweighted UniFrac\n")
cat("Permutations: 999\n\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")
if (length(unique(meta$species)) > 1) {
cat("1. Tree Species Effect (dm ~ tree_species):\n")
print(permanova_species)
cat("\n")
}
if (length(unique(meta$sample_type)) > 1) {
cat("2. Tissue Effect (dm ~ tissue):\n")
print(permanova_tissue)
cat("\n")
}
if (length(unique(meta$species)) > 1 && length(unique(meta$sample_type)) > 1) {
cat("3. Combined Effect (dm ~ tree_species + tissue):\n")
print(permanova_combined)
cat("\n")
cat("4. Interaction Effect (dm ~ tree_species * tissue):\n")
print(permanova_interaction)
cat("\n")
}
cat(paste(rep("=", 70), collapse = ""), "\n")
cat("\nInterpretation:\n")
cat("- Pr(>F) < 0.001: *** (highly significant)\n")
cat("- Pr(>F) < 0.01:  **  (significant)\n")
cat("- Pr(>F) < 0.05:  *   (marginally significant)\n")
cat("- Pr(>F) >= 0.05: not significant\n\n")
cat("PERMANOVA tests whether community composition differs significantly between groups.\n")
cat("R² represents the proportion of variance explained by each factor.\n")
sink()
cat("PERMANOVA results saved to file\n")
cat("\n", dataset_name, "analysis complete\n")
}
# Run analysis for both datasets
run_analysis(feature_table_bacteria, tax_table_bacteria, metadata,
"Results/denoise_mode/bacteria_only/bacteria_only", "Bacteria Only")
run_analysis(feature_table_bacteria_archaea, tax_table_bacteria_archaea, metadata,
"Results/denoise_mode/bacteria_archaea/bacteria_archaea", "Bacteria + Archaea")
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
setwd("/Users/jiayi/Desktop/metagenomic_pipeline/QIIME")
input_file <- "Results/denoise_mode/final-table-with-ranks.tsv"
output_plot <- "Results/denoise_mode/stacked_barplot_MOB.pdf"
# Load and preprocess data
header <- scan(input_file, what = "character", nlines = 1, sep = "\t", quiet = TRUE)
data <- read.table(input_file, sep = "\t", skip = 1, header = FALSE, stringsAsFactors = FALSE)
if (ncol(data) == length(header) + 1) {
colnames(data) <- c("FeatureID", header)
} else {
colnames(data) <- header
}
metadata_cols <- c("FeatureID", "Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")
sample_cols <- setdiff(colnames(data), metadata_cols)
sample_cols <- setdiff(sample_cols, c("A1", "A2"))
long_data <- data %>%
pivot_longer(cols = all_of(sample_cols), names_to = "SampleID", values_to = "Count") %>%
filter(Count > 0) %>%
mutate(
Domain = trimws(str_replace_all(Domain, "[a-z]__", "")),
Phylum = trimws(str_replace_all(Phylum, "[a-z]__", "")),
Class = trimws(str_replace_all(Class, "[a-z]__", "")),
Order = trimws(str_replace_all(Order, "[a-z]__", "")),
Family = trimws(str_replace_all(Family, "[a-z]__", "")),
Genus = trimws(str_replace_all(Genus, "[a-z]__", ""))
)
# Remove Cyanobacteria and Chloroplast
cat("Filtering out Cyanobacteria and Chloroplast...\n")
cat("  Features before filtering:", nrow(long_data), "\n")
long_data <- long_data %>%
filter(
!grepl("Cyanobacteria", Phylum, ignore.case = TRUE),
!grepl("Cyanobacteriia", Class, ignore.case = TRUE),
!grepl("Chloroplast", Order, ignore.case = TRUE),
!grepl("Chloroplast", Family, ignore.case = TRUE),
!grepl("Chloroplast", Genus, ignore.case = TRUE)
)
cat("  Features after filtering:", nrow(long_data), "\n\n")
# Filter datasets by domain
# Dataset 1: Bacteria only
long_data_bacteria <- long_data %>%
filter(grepl("Bacteria", Domain, ignore.case = TRUE))
# Dataset 2: Bacteria and Archaea
long_data_bacteria_archaea <- long_data %>%
filter(grepl("Bacteria|Archaea", Domain, ignore.case = TRUE))
cat("Dataset summary:\n")
cat("  Total features:", nrow(long_data), "\n")
cat("  Bacteria only:", nrow(long_data_bacteria), "\n")
cat("  Bacteria + Archaea:", nrow(long_data_bacteria_archaea), "\n\n")
# Create output directories for each dataset
dir.create("Results/denoise_mode/bacteria_only", showWarnings = FALSE, recursive = TRUE)
dir.create("Results/denoise_mode/bacteria_archaea", showWarnings = FALSE, recursive = TRUE)
# Function to run MOB analysis on a dataset
run_mob_analysis <- function(data_subset, output_prefix, dataset_name) {
cat("\n=== Processing", dataset_name, "===\n")
# MOB identification and filtering
target_genera <- c(
"Methylacidiphilum", "Crenothrix", "Methylibium", "Methylobacillus",
"Methylobacterium", "Methylocella", "Methylomonas", "Methylonatrum",
"Methylophaga", "Methylopila", "Methylosinus", "Methylovirgula"
)
target_pattern <- paste(target_genera, collapse = "|")
filtered_data <- data_subset %>%
mutate(
MatchedGenus = str_extract(Genus, regex(target_pattern, ignore_case = TRUE)),
IsUnclassifiedMethylophilaceae = grepl("Methylophilaceae", Family, ignore.case = TRUE) &
(Genus == "" | Genus == "uncultured" | Genus == "Unassigned"),
IsUnclassifiedMethylacidiphilaceae = grepl("Methylacidiphilaceae", Family, ignore.case = TRUE) &
(Genus == "" | Genus == "uncultured" | Genus == "Unassigned")
) %>%
filter(!is.na(MatchedGenus) | IsUnclassifiedMethylophilaceae | IsUnclassifiedMethylacidiphilaceae) %>%
mutate(
Taxon = case_when(
!is.na(MatchedGenus) ~ str_to_title(MatchedGenus),
IsUnclassifiedMethylophilaceae ~ "Unclassified Methylophilaceae",
IsUnclassifiedMethylacidiphilaceae ~ "Unclassified Methylacidiphilaceae"
),
Taxon = ifelse(Taxon == "Methylacidiphilum", "Candidatus Methylacidiphilum", Taxon)
)
if (nrow(filtered_data) == 0) {
cat("WARNING: No MOB species found in", dataset_name, "\n")
return(NULL)
}
# MOB relative abundance calculation and visualization
plot_data <- filtered_data %>%
group_by(SampleID, Taxon) %>%
summarise(Count = sum(Count), .groups = "drop") %>%
group_by(SampleID) %>%
mutate(RelativeAbundance = Count / sum(Count) * 100) %>%
ungroup()
plot_data <- plot_data %>%
mutate(Group = case_when(
grepl("B$", SampleID) ~ "Bark",
grepl("S$", SampleID) ~ "Soil",
TRUE ~ "Wood"
))
mob_colors <- c(
"Candidatus Methylacidiphilum" = "#CD5C5C",
"Crenothrix" = "black",
"Methylibium" = "#FF8C00",
"Methylobacillus" = "#98FB98",
"Methylobacterium" = "#7FFF00",
"Methylocella" = "#8B4513",
"Methylomonas" = "#E6E6FA",
"Methylonatrum" = "#483D8B",
"Methylophaga" = "#800080",
"Methylopila" = "#C0C0C0",
"Methylosinus" = "#DA70D6",
"Unclassified Methylophilaceae" = "#AFEEEE"
)
plot_data$Taxon <- factor(plot_data$Taxon, levels = sort(unique(plot_data$Taxon)))
p <- ggplot(plot_data, aes(x = SampleID, y = RelativeAbundance, fill = Taxon)) +
geom_bar(stat = "identity", width = 0.8) +
facet_grid(~ Group, scales = "free_x", space = "free_x") +
scale_y_continuous(expand = c(0, 0)) +
scale_fill_manual(values = mob_colors) +
labs(x = "Tree", y = "Relative abundance (%)", fill = "MOB - 16S",
title = paste("MOB Distribution -", dataset_name)) +
theme_bw() +
theme(
axis.text.x = element_text(angle = 0, hjust = 0.5),
panel.grid = element_blank(),
strip.background = element_rect(fill = "white", colour = "black"),
strip.text = element_text(size = 12),
legend.position = "right",
legend.text = element_text(size = 10, face = "italic")
)
print(p)
ggsave(paste0(output_prefix, "_stacked_barplot_MOB.pdf"), p, width = 10, height = 6)
ggsave(paste0(output_prefix, "_stacked_barplot_MOB.png"), p, width = 10, height = 6)
# MOB total relative abundance per sample
mob_totals <- filtered_data %>%
group_by(SampleID) %>%
summarise(MOB_Total = sum(Count)) %>%
ungroup()
all_totals <- data_subset %>%
group_by(SampleID) %>%
summarise(Total_Abundance = sum(Count)) %>%
ungroup()
mob_rel_abundance <- mob_totals %>%
left_join(all_totals, by = "SampleID") %>%
mutate(
MOB_RelAbundance = MOB_Total / Total_Abundance * 100,
Species = str_extract(SampleID, "^[A-Z]"),
Surrounding = case_when(
grepl("B$", SampleID) ~ "Bark",
grepl("S$", SampleID) ~ "Soil",
TRUE ~ "Wood"
)
)
mob_per_sample <- mob_rel_abundance %>%
select(SampleID, Species, Surrounding, MOB_RelAbundance) %>%
rename(`MOB_RelAbundance (%)` = MOB_RelAbundance)
print("=== MOB Relative Abundance Per Sample ===")
print(mob_per_sample)
write.csv(mob_per_sample, paste0(output_prefix, "_MOB_relative_abundance_per_sample.csv"), row.names = FALSE)
# Dominant vs rare MOB group classification
mob_genus_totals <- plot_data %>%
group_by(Taxon) %>%
summarise(Total_RelAbundance = sum(RelativeAbundance)) %>%
arrange(desc(Total_RelAbundance)) %>%
ungroup()
key_groups <- mob_genus_totals %>%
slice(1:4) %>%
pull(Taxon)
mob_classification <- mob_genus_totals %>%
mutate(
Group_Type = case_when(
Taxon %in% key_groups ~ "Dominant/Key Group",
TRUE ~ "Rare Group"
),
Rank = row_number()
)
print("=== MOB Group Classification ===")
print(mob_classification)
write.csv(mob_classification, paste0(output_prefix, "_MOB_group_classification.csv"), row.names = FALSE)
# Key species identification by site
mob_by_site <- plot_data %>%
group_by(Group, Taxon) %>%
summarise(Total_RelAbundance = sum(RelativeAbundance), .groups = "drop") %>%
arrange(Group, desc(Total_RelAbundance))
key_species_by_site <- mob_by_site %>%
group_by(Group) %>%
slice(1:3) %>%
mutate(Rank = row_number()) %>%
ungroup()
print("\n=== Key MOB Species by Site (Top 3 per Surrounding) ===")
print(key_species_by_site)
write.csv(key_species_by_site, paste0(output_prefix, "_MOB_key_species_by_site.csv"), row.names = FALSE)
cat("\n", dataset_name, "analysis complete\n")
}
# Run analysis for both datasets
run_mob_analysis(long_data_bacteria, "Results/denoise_mode/bacteria_only/bacteria_only", "Bacteria Only")
run_mob_analysis(long_data_bacteria_archaea, "Results/denoise_mode/bacteria_archaea/bacteria_archaea", "Bacteria + Archaea")
# Function to run analysis on a dataset
run_analysis <- function(ft, tt, meta, output_prefix, dataset_name) {
cat("\n=== Processing", dataset_name, "===\n")
# Relative abundance
rel_abundance <- sweep(ft, 2, colSums(ft), "/") * 100
# Aggregate by genus
aggregate_by_level <- function(feat_table, tax_table, level) {
# Ensure feature tables and taxonomy tables are aligned
common_features <- intersect(rownames(feat_table), rownames(tax_table))
feat_table <- feat_table[common_features, , drop = FALSE]
tax_table <- tax_table[common_features, , drop = FALSE]
taxa <- tax_table[, level]
taxa[is.na(taxa)] <- "Unclassified"
agg_table <- aggregate(feat_table, by = list(Taxa = taxa), FUN = sum)
rownames(agg_table) <- agg_table$Taxa
agg_table$Taxa <- NULL
return(as.data.frame(agg_table))
}
genus_abund <- aggregate_by_level(rel_abundance, tt, "Genus")
# Heatmap
plot_heatmap <- function(abund_table, metadata, top_n = 30, cluster_samples = TRUE, group_var = "sample_type") {
mean_abund <- rowMeans(abund_table)
top_taxa <- names(sort(mean_abund, decreasing = TRUE)[1:top_n])
heat_data <- abund_table[top_taxa, ]
heat_data_log <- log10(heat_data + 0.01)
annotation_col <- metadata[, group_var, drop = FALSE]
# Custom colors for sample_type annotation
sample_types <- unique(metadata[, group_var])
annotation_colors <- list()
if (length(sample_types) == 3) {
annotation_colors[[group_var]] <- c("green3", "purple3", "gold")
names(annotation_colors[[group_var]]) <- sort(sample_types)
}
pheatmap::pheatmap(
heat_data_log,
cluster_rows = TRUE,
cluster_cols = cluster_samples,
annotation_col = annotation_col,
annotation_colors = annotation_colors,
color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
fontsize = 8,
fontsize_row = 7,
fontsize_col = 8,
main = paste("Top", top_n, "Taxa Heatmap -", dataset_name, "\n[log10(Relative Abundance %)]"),
filename = paste0(output_prefix, "_taxa_heatmap.pdf"),
width = 10,
height = 12
)
}
plot_heatmap(genus_abund, meta, top_n = 30, group_var = "sample_type")
cat("Heatmap saved\n")
# Alpha diversity
alpha_div <- data.frame(
Sample = colnames(ft),
Observed = colSums(ft > 0),
Shannon = vegan::diversity(t(ft), index = "shannon"),
Simpson = vegan::diversity(t(ft), index = "simpson")
)
alpha_div <- cbind(alpha_div, meta[alpha_div$Sample, ])
alpha_long <- alpha_div %>%
pivot_longer(cols = c(Observed, Shannon, Simpson), names_to = "Metric", values_to = "Value")
p_alpha <- ggplot(alpha_long, aes(x = sample_type, y = Value, fill = sample_type)) +
geom_boxplot() +
facet_wrap(~ Metric, scales = "free_y") +
theme_bw() +
labs(title = paste("Alpha Diversity -", dataset_name), x = "Sample Type", y = "Value") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(p_alpha)
ggsave(paste0(output_prefix, "_alpha_diversity_boxplot.pdf"), p_alpha, width = 10, height = 4)
cat("Alpha diversity boxplot saved\n")
# PCoA ordination using Unweighted UniFrac from QIIME2
cat("\n=== PCoA with Unweighted UniFrac ===\n")
unweighted_pcoa_file <- "Results/denoise_mode/diversity/exported-unweighted_unifrac-pcoa/ordination.txt"
unweighted_dist_file <- "Results/denoise_mode/diversity/exported-unweighted_unifrac/distance-matrix.tsv"
# Parse QIIME2 ordination file
lines <- readLines(unweighted_pcoa_file)
prop_idx <- grep("^Proportion", lines)
site_idx <- grep("^Site", lines)
percent_var <- round(as.numeric(lines[(prop_idx + 1):(site_idx - 1)]) * 100, 2)
coord_lines <- lines[(site_idx + 1):length(lines)]
coord_lines <- coord_lines[coord_lines != ""]
coord_matrix <- do.call(rbind, strsplit(coord_lines, "\\t"))
pcoa_scores <- data.frame(
Sample = coord_matrix[, 1],
PC1 = as.numeric(coord_matrix[, 2]),
PC2 = as.numeric(coord_matrix[, 3]),
stringsAsFactors = FALSE
)
rownames(pcoa_scores) <- pcoa_scores$Sample
# Only keep samples that exist in metadata
common_samples <- intersect(pcoa_scores$Sample, rownames(meta))
pcoa_scores <- pcoa_scores[common_samples, ]
pcoa_scores <- cbind(pcoa_scores, meta[pcoa_scores$Sample, ])
# Read distance matrix for PERMANOVA
unifrac_dist_data <- read.table(unweighted_dist_file, sep = "\t", header = TRUE, row.names = 1)
unifrac_dist_data <- unifrac_dist_data[common_samples, common_samples]
pcoa_dist <- as.dist(unifrac_dist_data)
cat("Using QIIME2 Unweighted UniFrac results\n")
# Plot PCoA
cat("\n=== Plotting PCoA ===\n")
p_pcoa <- ggplot(pcoa_scores, aes(x = PC1, y = PC2, color = sample_type, shape = species)) +
geom_point(size = 4, alpha = 0.8) +
theme_bw() +
labs(
title = paste("PCoA - Unweighted UniFrac -", dataset_name),
x = paste0("PC1 (", percent_var[1], "%)"),
y = paste0("PC2 (", percent_var[2], "%)"),
color = "Sample Type",
shape = "Species"
) +
theme(
legend.position = "right",
plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
)
print(p_pcoa)
ggsave(paste0(output_prefix, "_pcoa_unweighted_unifrac.pdf"), p_pcoa, width = 10, height = 7)
cat("PCoA plot saved to:", paste0(output_prefix, "_pcoa_unweighted_unifrac.pdf\n"))
# PERMANOVA analysis
cat("\n=== PERMANOVA Analysis ===\n")
# Ensure metadata matches distance matrix samples
dist_samples <- labels(pcoa_dist)
meta_subset <- meta[dist_samples, ]
# Run tests
if (length(unique(meta_subset$species)) > 1) {
permanova_species <- adonis2(pcoa_dist ~ species, data = meta_subset, permutations = 999)
cat("\n1. Tree Species Effect:\n")
print(permanova_species)
}
if (length(unique(meta_subset$sample_type)) > 1) {
permanova_tissue <- adonis2(pcoa_dist ~ sample_type, data = meta_subset, permutations = 999)
cat("\n2. Tissue Effect:\n")
print(permanova_tissue)
}
if (length(unique(meta_subset$species)) > 1 && length(unique(meta_subset$sample_type)) > 1) {
permanova_combined <- adonis2(pcoa_dist ~ species + sample_type, data = meta_subset, permutations = 999)
cat("\n3. Combined Effect:\n")
print(permanova_combined)
permanova_interaction <- adonis2(pcoa_dist ~ species * sample_type, data = meta_subset, permutations = 999)
cat("\n4. Interaction Effect:\n")
print(permanova_interaction)
}
# Save results
sink(paste0(output_prefix, "_PERMANOVA_results.txt"))
cat("PERMANOVA Test Results -", dataset_name, "\n")
cat("Date:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("Distance metric: Unweighted UniFrac\n")
cat("Permutations: 999\n\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")
if (length(unique(meta$species)) > 1) {
cat("1. Tree Species Effect (dm ~ tree_species):\n")
print(permanova_species)
cat("\n")
}
if (length(unique(meta$sample_type)) > 1) {
cat("2. Tissue Effect (dm ~ tissue):\n")
print(permanova_tissue)
cat("\n")
}
if (length(unique(meta$species)) > 1 && length(unique(meta$sample_type)) > 1) {
cat("3. Combined Effect (dm ~ tree_species + tissue):\n")
print(permanova_combined)
cat("\n")
cat("4. Interaction Effect (dm ~ tree_species * tissue):\n")
print(permanova_interaction)
cat("\n")
}
cat(paste(rep("=", 70), collapse = ""), "\n")
cat("\nInterpretation:\n")
cat("- Pr(>F) < 0.001: *** (highly significant)\n")
cat("- Pr(>F) < 0.01:  **  (significant)\n")
cat("- Pr(>F) < 0.05:  *   (marginally significant)\n")
cat("- Pr(>F) >= 0.05: not significant\n\n")
cat("PERMANOVA tests whether community composition differs significantly between groups.\n")
cat("R² represents the proportion of variance explained by each factor.\n")
sink()
cat("PERMANOVA results saved to file\n")
cat("\n", dataset_name, "analysis complete\n")
}
# Run analysis for both datasets
run_analysis(feature_table_bacteria, tax_table_bacteria, metadata,
"Results/denoise_mode/bacteria_only/bacteria_only", "Bacteria Only")
run_analysis(feature_table_bacteria_archaea, tax_table_bacteria_archaea, metadata,
"Results/denoise_mode/bacteria_archaea/bacteria_archaea", "Bacteria + Archaea")
